"use strict";(self["webpackChunkvideogatewayweb"]=self["webpackChunkvideogatewayweb"]||[]).push([[613],{6613:function(t,e,o){o.r(e),o.d(e,{default:function(){return at}});var i=function(){var t=this,e=t._self._c;return e("div",[t.showPage?e("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}]},[e("div",{staticClass:"relative"},[e("div",{staticClass:"flex-interval"},[t._v(" 数据源列表 "),e("div",[t._v(" 操作 "),e("i",{staticClass:"el-icon el-icon-circle-plus-outline",attrs:{title:"添加数据源"},on:{click:t.addDataSource}}),e("i",{staticClass:"el-icon el-icon-upload2"}),e("i",{staticClass:"el-icon el-icon-download"})])]),t.dataSourceTotal>0?e("div",{staticClass:"dataList relative"},t._l(t.dataSourceList,function(o,i){return e("div",{key:o.source_id,staticClass:"dataItem",style:t.sourceTab==i?"border-color:#409eff;background: aliceblue;":"",on:{click:function(e){return t.changeSource(o,i)}}},[e("div",{staticClass:"flex-interval"},[e("div",{staticClass:"d-center"},[e("div",{staticClass:"mr-5",style:1==o.status?"color:#409eff":"color:#a6a6a6"},[t._v(" ● ")]),e("div",{staticClass:"title"},[e("span",{attrs:{title:o.source_name}},[t._v(t._s(o.source_name))])]),e("i",{staticClass:"el-icon el-icon-edit",attrs:{disabled:t.sourceTab==i,title:"编辑"},on:{click:function(e){return t.editDataSource(o)}}})]),e("div",{staticClass:"flex-interval",staticStyle:{width:"36%"}},[e("i",{staticClass:"el-icon el-icon-setting",attrs:{title:"配置参数"},on:{click:function(e){return t.configureDeviceParameters(o,i)}}}),e("i",{staticClass:"el-icon el-icon-search",attrs:{title:"日志"}}),e("i",{staticClass:"el-icon el-icon-price-tag",attrs:{title:"标签"},on:{click:function(e){return t.handleTag(o)}}}),e("i",{staticClass:"el-icon el-icon-delete",staticStyle:{color:"red !important"},attrs:{title:"删除"},on:{click:function(e){return t.delDataSource(o,i)}}})])]),e("div",{staticClass:"fs-14 mt-10 flex-interval",staticStyle:{float:"right"}},[e("el-switch",{attrs:{disabled:!t.analyzeProperty(o.channel_config||null)||o.disabled,"active-value":1,"inactive-value":2},on:{change:function(e){return t.changeDataStatus(o)}},model:{value:o.status,callback:function(e){t.$set(o,"status",e)},expression:"item.status"}})],1),e("div",{staticClass:"mt-30 fs-14"},[e("div",[t._v(t._s(t.source_type.get(o.driver_protocol).name))]),e("div",{staticClass:"mt-5"},[t._v("--")]),e("div",{staticClass:"mt-5"},[t._v("--")])])])}),0):e("el-empty",{staticClass:"p-0",attrs:{"image-size":80}}),e("div",{staticClass:"d-flex d-end mt-10"},[e("pagination",{directives:[{name:"show",rawName:"v-show",value:t.dataSourceTotal>0,expression:"dataSourceTotal > 0"}],staticClass:"",attrs:{total:t.dataSourceTotal,page:t.dataSource.page,limit:t.dataSource.size,layout:"total, prev, pager, next",small:""},on:{"update:page":function(e){return t.$set(t.dataSource,"page",e)},"update:limit":function(e){return t.$set(t.dataSource,"size",e)},pagination:t.getDataSourcePage}})],1)],1),e("el-divider",{staticClass:"mt-20"}),e("div",[e("div",{staticClass:"flex-interval"},[t._v(" 属性列表 "),e("div",[t._v(" 操作 "),e("i",{staticClass:"el-icon el-icon-circle-plus-outline",on:{click:t.addAttribute}}),e("i",{staticClass:"el-icon el-icon-upload2"}),e("i",{staticClass:"el-icon el-icon-download"})])]),e("div",{staticClass:"relative"},[e("div",{staticClass:"absolute r-0 t-5"},[e("el-input",{attrs:{size:"mini",placeholder:"请输入内容"},model:{value:t.input,callback:function(e){t.input=e},expression:"input"}})],1),e("el-tabs",{on:{"tab-click":t.handleClick},model:{value:t.activeName,callback:function(e){t.activeName=e},expression:"activeName"}},[e("el-tab-pane",{attrs:{label:"采集",name:"1"}},[e(t.componentsListName,{key:t.componentKey,ref:"listRef",tag:"component",attrs:{chooseItem:t.chooseItem,attributeList:t.attributeList,sourceTab:t.sourceTab}})],1)],1)],1)]),t.dataSourceVisible?e("el-dialog",{attrs:{title:t.dataSourceVisibleTitle,visible:t.dataSourceVisible,width:"30%","close-on-click-modal":!1},on:{"update:visible":function(e){t.dataSourceVisible=e}}},[e("el-form",{ref:"ruleForm",staticClass:"demo-ruleForm",attrs:{model:t.ruleForm,rules:t.rules,"label-width":"100px"}},[e("el-form-item",{attrs:{label:"数据源名称",prop:"source_name"}},[e("el-input",{staticStyle:{width:"60%"},model:{value:t.ruleForm.source_name,callback:function(e){t.$set(t.ruleForm,"source_name",e)},expression:"ruleForm.source_name"}})],1),t.ruleForm.source_id?e("el-form-item",{attrs:{label:"设备ID",prop:"device_id"}},[e("el-input",{staticStyle:{width:"60%"},model:{value:t.ruleForm.device_id,callback:function(e){t.$set(t.ruleForm,"device_id",e)},expression:"ruleForm.device_id"}})],1):t._e(),e("el-form-item",{attrs:{label:"驱动协议",prop:"driver_protocol"}},[e("el-select",{attrs:{disabled:t.ruleForm.source_id},model:{value:t.ruleForm.driver_protocol,callback:function(e){t.$set(t.ruleForm,"driver_protocol",e)},expression:"ruleForm.driver_protocol"}},t._l(t.source_type.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o.name,value:t}})}),1)],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.dataSourceVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitForm("ruleForm")}}},[t._v("确 定")])],1)],1):t._e()],1):e("div",[e("el-page-header",{attrs:{content:t.configureDevice.source_name},on:{back:t.goBack}}),e(t.componentsName,{key:t.componentKeys,tag:"component",attrs:{protocolForm:t.protocolForm,channelForm:t.channelForm,source_id:t.configureDevice.source_id,parentMethod:t.goBack}})],1),e("el-dialog",{attrs:{title:"编辑标签",visible:t.tagVisible,width:"30%","close-on-click-modal":!1},on:{"update:visible":function(e){t.tagVisible=e}}},[t._l(t.tagList,function(o,i){return e("div",{key:i,staticClass:"flex-interval f-center mb-10"},[e("el-input",{staticStyle:{width:"30%"},attrs:{size:"small",placeholder:"标签名"},model:{value:o.value1,callback:function(e){t.$set(o,"value1",e)},expression:"item.value1"}}),e("el-input",{staticStyle:{width:"30%"},attrs:{size:"small",placeholder:"标签值"},model:{value:o.value2,callback:function(e){t.$set(o,"value2",e)},expression:"item.value2"}}),e("el-radio-group",{attrs:{size:"small"},model:{value:o.type,callback:function(e){t.$set(o,"type",e)},expression:"item.type"}},[e("el-radio-button",{attrs:{label:1,border:""}},[t._v("文本")]),e("el-radio-button",{attrs:{label:2,border:""}},[t._v("数字")])],1),e("i",{staticClass:"el-icon-delete",staticStyle:{color:"red"},on:{click:function(e){return t.delTag(i)}}})],1)}),e("div",{staticClass:"addtag mt-10",on:{click:t.addTag}},[e("i",{staticClass:"el-icon-plus"}),t._v("新增标签 ")]),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.tagVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:t.submitTag}},[t._v("确 定")])],1)],2)],1)},a=[],r=(o(5786),o(3239),o(6332),o(3325),o(2454)),l=function(){var t=this,e=t._self._c;return e("div",{staticClass:"d-center column m-10"},[e("el-steps",{staticStyle:{width:"50%"},attrs:{active:t.active,"finish-status":"success"}},[e("el-step",{attrs:{title:"配置通道参数"}}),e("el-step",{attrs:{title:"配置协议参数"}})],1),e("el-form",{directives:[{name:"show",rawName:"v-show",value:0==t.active,expression:"active == 0"}],ref:"channelInfo",staticClass:"mt-20",attrs:{model:t.channelInfo,rules:t.rules,"label-width":"120px",size:"small"}},[e("el-form-item",{attrs:{label:"IP地址:",prop:"ip"}},[e("el-input",{staticStyle:{width:"60%"},attrs:{disabled:""},model:{value:t.channelInfo.ip,callback:function(e){t.$set(t.channelInfo,"ip",e)},expression:"channelInfo.ip"}}),e("el-button",{attrs:{type:"text"},on:{click:function(e){t.autoAddVisible=!0}}},[t._v("自动添加")])],1),e("el-form-item",{attrs:{label:"用户名:",prop:"user"}},[e("el-input",{model:{value:t.channelInfo.user,callback:function(e){t.$set(t.channelInfo,"user",e)},expression:"channelInfo.user"}})],1),e("el-form-item",{attrs:{label:"密码:",prop:"pwd"}},[e("el-input",{attrs:{type:"password","show-password":""},model:{value:t.channelInfo.pwd,callback:function(e){t.$set(t.channelInfo,"pwd",e)},expression:"channelInfo.pwd"}})],1),e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitChannel("channelInfo")}}},[t._v("下一步")])],1)],1),1==t.active?e("el-form",{ref:"protocolInfo",staticClass:"mt-20",attrs:{model:t.protocolInfo,rules:t.rules,"label-width":"140px",size:"small"}},[e("el-form-item",{attrs:{label:"视频编码:",prop:"video_encoding"}},[e("el-select",{model:{value:t.protocolInfo.video_encoding,callback:function(e){t.$set(t.protocolInfo,"video_encoding",e)},expression:"protocolInfo.video_encoding"}},[e("el-option",{attrs:{label:"h264",value:1}}),e("el-option",{attrs:{label:"h265",value:2}})],1)],1),e("el-form-item",{attrs:{label:"读取视频帧率:",prop:"interval"}},[e("el-input-number",{attrs:{min:1,max:25},model:{value:t.protocolInfo.interval,callback:function(e){t.$set(t.protocolInfo,"interval",e)},expression:"protocolInfo.interval"}})],1),e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){t.active=0}}},[t._v("上一步")]),e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitProtocol("protocolInfo")}}},[t._v("提交")])],1)],1):t._e(),e("el-dialog",{attrs:{title:"自动添加",width:"40%",visible:t.autoAddVisible},on:{"update:visible":function(e){t.autoAddVisible=e},open:t.getIPList}},[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.IPloading,expression:"IPloading"}],staticClass:"cursor",staticStyle:{width:"100%"},attrs:{data:t.deviceList},on:{"row-click":t.addRowData}},[e("el-table-column",{attrs:{prop:"type",label:"类型",align:"center"}},[[t._v("onvif")]],2),e("el-table-column",{attrs:{prop:"ip",label:"IP地址",align:"center"}})],1)],1)],1)},s=[],n={props:{protocolForm:{type:Object,default:()=>({})},channelForm:{type:Object,default:()=>({})},source_id:{type:Number}},data(){return{channelInfo:{},protocolInfo:{},rules:{},active:0,autoAddVisible:!1,deviceList:[],IPloading:!0}},created(){this.channelInfo={...this.channelForm},this.protocolInfo={...this.protocolForm,interval:this.protocolForm.interval||25,video_encoding:this.protocolForm.video_encoding||1}},methods:{submitChannel(t){this.active=1,this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setChannelConfig",{source_id:this.source_id,channel_config:this.channelInfo}).then(()=>{this.active=1})})},submitProtocol(t){this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setProtocolConfig",{source_id:this.source_id,protocol_config:this.protocolInfo}).then(()=>{this.$parent.goBack(),this.$message.success("操作成功")})})},addRowData(t){this.channelInfo.address=t.addr,this.channelInfo.ip=t.ip,this.autoAddVisible=!1},getIPList(){this.$api.get("/collect/getDataDeviceList",{params:{driver_protocol:2}}).then(t=>{t.data.data&&(this.deviceList=JSON.parse(t.data.data).map(t=>({ip:this.extractIPFromONVIF(t),addr:t})),this.IPloading=!1)}).finally(()=>{this.IPloading=!1})},extractIPFromONVIF(t){const e=t.match(/\[([a-fA-F0-9:]+)\]/);if(e)return e[1];const o=t.match(/(?:http:\/\/)?(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?/);return o?o[1]:null}}},c=n,u=o(6790),p=(0,u.A)(c,l,s,!1,null,"5107e017",null),m=p.exports,d=function(){var t=this,e=t._self._c;return e("div",{staticClass:"d-center column m-10"},[e("el-steps",{staticStyle:{width:"50%"},attrs:{active:t.active,"finish-status":"success"}},[e("el-step",{attrs:{title:"配置通道参数"}}),e("el-step",{attrs:{title:"配置协议参数"}})],1),e("el-form",{directives:[{name:"show",rawName:"v-show",value:0==t.active,expression:"active == 0"}],ref:"channelInfo",staticClass:"mt-20",attrs:{model:t.channelInfo,rules:t.rules,"label-width":"120px",size:"small"}},[e("el-form-item",{attrs:{label:"传输模式:",prop:"transport_mode"}},[e("el-select",{model:{value:t.channelInfo.transport_mode,callback:function(e){t.$set(t.channelInfo,"transport_mode",e)},expression:"channelInfo.transport_mode"}},[e("el-option",{attrs:{label:"tcp",value:1}}),e("el-option",{attrs:{label:"rtu",value:2}})],1)],1),e("el-form-item",{attrs:{label:"传输协议:",prop:"transport_protocol"}},[e("el-select",{model:{value:t.channelInfo.transport_protocol,callback:function(e){t.$set(t.channelInfo,"transport_protocol",e)},expression:"channelInfo.transport_protocol"}},[e("el-option",{attrs:{label:"modbus TCP",value:1}}),e("el-option",{attrs:{label:"modbus RTU",value:2}})],1)],1),e("el-form-item",{attrs:{label:"工作模式:",prop:"working_mode"}},[e("el-select",{model:{value:t.channelInfo.working_mode,callback:function(e){t.$set(t.channelInfo,"working_mode",e)},expression:"channelInfo.working_mode"}},[e("el-option",{attrs:{label:"服务端",value:1}}),e("el-option",{attrs:{label:"客户端",value:2}})],1)],1),2==t.channelInfo.transport_mode?[e("el-form-item",{attrs:{label:"串口:",prop:"serial_ports"}},[e("el-select",{model:{value:t.channelInfo.serial_ports,callback:function(e){t.$set(t.channelInfo,"serial_ports",e)},expression:"channelInfo.serial_ports"}},t._l(t.serialPortList,function(t,o){return e("el-option",{key:o,attrs:{label:t,value:t}})}),1)],1),e("el-form-item",{attrs:{label:"波特率:",prop:"baud_rate"}},[e("el-select",{model:{value:t.channelInfo.baud_rate,callback:function(e){t.$set(t.channelInfo,"baud_rate",e)},expression:"channelInfo.baud_rate"}},t._l(t.baudRateList,function(t,o){return e("el-option",{key:o,attrs:{label:t,value:t}})}),1)],1),e("el-form-item",{attrs:{label:"数据位:",prop:"data_bit"}},[e("el-select",{model:{value:t.channelInfo.data_bit,callback:function(e){t.$set(t.channelInfo,"data_bit",e)},expression:"channelInfo.data_bit"}},t._l(t.databitList,function(t,o){return e("el-option",{key:o,attrs:{label:t,value:t}})}),1)],1),e("el-form-item",{attrs:{label:"停止位:",prop:"stop_bit"}},[e("el-select",{model:{value:t.channelInfo.stop_bit,callback:function(e){t.$set(t.channelInfo,"stop_bit",e)},expression:"channelInfo.stop_bit"}},[e("el-option",{attrs:{label:"1",value:1}}),e("el-option",{attrs:{label:"2",value:2}})],1)],1),e("el-form-item",{attrs:{label:"校验位:",prop:"check_bit"}},[e("el-select",{model:{value:t.channelInfo.check_bit,callback:function(e){t.$set(t.channelInfo,"check_bit",e)},expression:"channelInfo.check_bit"}},[e("el-option",{attrs:{label:"无校验",value:0}}),e("el-option",{attrs:{label:"奇校验",value:1}}),e("el-option",{attrs:{label:"偶校验",value:2}})],1)],1)]:1==t.channelInfo.working_mode?[e("el-form-item",{attrs:{label:"端口:",prop:"port"}},[e("el-input-number",{model:{value:t.channelInfo.port,callback:function(e){t.$set(t.channelInfo,"port",e)},expression:"channelInfo.port"}})],1)]:[e("el-form-item",{attrs:{label:"IP地址:",prop:"address"}},[e("el-input",{model:{value:t.channelInfo.address,callback:function(e){t.$set(t.channelInfo,"address",e)},expression:"channelInfo.address"}})],1),e("el-form-item",{attrs:{label:"端口:",prop:"port"}},[e("el-input-number",{model:{value:t.channelInfo.port,callback:function(e){t.$set(t.channelInfo,"port",e)},expression:"channelInfo.port"}})],1)],e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitChannel("channelInfo")}}},[t._v("下一步")])],1)],2),1==t.active?e("el-form",{ref:"protocolInfo",staticClass:"mt-20",attrs:{model:t.protocolInfo,rules:t.rules,"label-width":"140px",size:"small"}},[e("el-form-item",{attrs:{label:"从站号:",prop:"slaveId"}},[e("el-input-number",{attrs:{min:0},model:{value:t.protocolInfo.slaveId,callback:function(e){t.$set(t.protocolInfo,"slaveId",e)},expression:"protocolInfo.slaveId"}})],1),e("el-form-item",{attrs:{label:"轮训时间（毫秒）:",prop:"pollingTime"}},[e("el-input-number",{attrs:{min:1e3},model:{value:t.protocolInfo.pollingTime,callback:function(e){t.$set(t.protocolInfo,"pollingTime",e)},expression:"protocolInfo.pollingTime"}})],1),e("el-form-item",{attrs:{label:"超时时间（毫秒）:",prop:"timeout"}},[e("el-input-number",{attrs:{min:1e4},model:{value:t.protocolInfo.timeout,callback:function(e){t.$set(t.protocolInfo,"timeout",e)},expression:"protocolInfo.timeout"}})],1),e("el-form-item",{attrs:{label:"间隔时间（毫秒）:",prop:"interval"}},[e("el-input-number",{attrs:{min:1e3},model:{value:t.protocolInfo.interval,callback:function(e){t.$set(t.protocolInfo,"interval",e)},expression:"protocolInfo.interval"}})],1),e("el-form-item",{attrs:{label:"模式:",prop:"mode"}},[e("el-radio-group",{model:{value:t.protocolInfo.mode,callback:function(e){t.$set(t.protocolInfo,"mode",e)},expression:"protocolInfo.mode"}},[e("el-radio",{attrs:{label:1}},[t._v("请求模式")]),e("el-radio",{attrs:{label:2}},[t._v("监听模式")])],1)],1),e("el-form-item",{attrs:{label:"采集数量:",prop:"collectCount"}},[e("el-input-number",{attrs:{min:1},model:{value:t.protocolInfo.collectCount,callback:function(e){t.$set(t.protocolInfo,"collectCount",e)},expression:"protocolInfo.collectCount"}})],1),e("el-form-item",{attrs:{label:"上报模式:",prop:"reportMode"}},[e("el-radio-group",{model:{value:t.protocolInfo.reportMode,callback:function(e){t.$set(t.protocolInfo,"reportMode",e)},expression:"protocolInfo.reportMode"}},[e("el-radio",{attrs:{label:1}},[t._v("全部采集完成")]),e("el-radio",{attrs:{label:2}},[t._v("立即")])],1)],1),e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){t.active=0}}},[t._v("上一步")]),e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitProtocol("protocolInfo")}}},[t._v("提交")])],1)],1):t._e()],1)},f=[],b={props:{protocolForm:{type:Object,default:()=>({})},channelForm:{type:Object,default:()=>({})},source_id:{type:Number}},data(){let t=(t,e,o)=>{const i=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;i.test(e)?o():o(new Error("格式错误 格式:XXX.XXX.XXX.XXX"))},e=(t,e,o)=>{/^[1-9]\d*$/.test(e)&&1<=1*e&&1*e<=65535?o():o(new Error("端口为0-65535"))};return{channelInfo:{},protocolInfo:{},rules:{source_name:[{required:!0,message:"请输入",trigger:"blur"}],"protocol_config.driver_protocol":[{required:!0,message:"请选择",trigger:"change"}],"protocol_config.working_mode":[{required:!0,message:"请选择",trigger:"change"}],"protocol_config.address":[{required:!0,message:"请输入",trigger:"change"},{validator:t,trigger:"change"}],"protocol_config.port":[{required:!0,message:"请输入",trigger:"change"},{validator:e,trigger:"change"}],"protocol_config.identifer":[{required:!0,message:"请输入",trigger:"blur"}],"protocol_config.operation_type":[{required:!0,message:"请选择",trigger:"change"}],"protocol_config.data_type":[{required:!0,message:"请选择",trigger:"change"}],"protocol_config.base_value":[{required:!0,message:"请输入",trigger:"blur"}],"protocol_config.scale_factor":[{required:!0,message:"请输入",trigger:"blur"}],"protocol_config.decimal_point":[{required:!0,message:"请选择",trigger:"change"}],"protocol_config.decimal_point_num":[{required:!0,message:"请输入",trigger:"blur"}],"protocol_config.interval_time":[{required:!0,message:"请选择",trigger:"change"}],"protocol_config.report_method":[{required:!0,message:"请选择",trigger:"change"}]},active:0,deviceList:[],serialPortList:[],baudRateList:[9600,14400,19200,38400,57600,115200],databitList:[5,6,7,8]}},created(){this.channelInfo={...this.channelForm,baud_rate:this.channelForm.baud_rate||9600,data_bit:this.channelForm.data_bit||8,stop_bit:this.channelForm.stop_bit||1,check_bit:this.channelForm.baud_rate||0},this.protocolInfo={...this.protocolForm,interval:this.protocolForm.interval||1e3,pollingTime:this.protocolForm.pollingTime||1e3,timeout:this.protocolForm.timeout||1e3}},watch:{"channelInfo.transport_mode"(t){2==t&&this.getSerialPortList()}},methods:{getSerialPortList(){this.serialPortList=[],this.$api.get("/collect/getSerialPortList").then(t=>{this.serialPortList=t.data.data})},submitChannel(t){this.active=1,this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setChannelConfig",{source_id:this.source_id,channel_config:this.channelInfo}).then(()=>{this.active=1})})},submitProtocol(t){this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setProtocolConfig",{source_id:this.source_id,protocol_config:this.protocolInfo}).then(()=>{this.$parent.goBack(),this.$message.success("操作成功")})})}}},h=b,_=(0,u.A)(h,d,f,!1,null,"c5930c86",null),g=_.exports,v=function(){var t=this,e=t._self._c;return e("div",[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{size:"mini",data:t.attributeList}},[e("el-table-column",{attrs:{prop:"describe",label:"通道名称",align:"center"}}),e("el-table-column",{attrs:{prop:"channel_id",label:"通道编号",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config?e.row.protocol_config.channel_id:"")+" ")]}}])}),e("el-table-column",{attrs:{label:"报警事件",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[o.row.analysisData?e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.getDataAiValueList(o.row.analysisData,o.row.analysisData[0].is_alarm)}}},[t._v(t._s(JSON.parse(o.row.analysisData[0].ai_value).ai_name))]):t._e()]}}])}),e("el-table-column",{attrs:{prop:"protocol_config.interval_time",label:"拍照时间间隔（秒）",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config?e.row.protocol_config.interval_time:"")+" ")]}}])}),e("el-table-column",{attrs:{prop:"ai_file",label:"报警图片",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[o.row.analysisData&&""!==o.row.analysisData[0].ai_file?e("el-image",{staticStyle:{width:"100px",height:"80px"},attrs:{src:o.row.analysisData[0].ai_file,"preview-src-list":[o.row.analysisData[0].ai_file],fit:"fill",referrerpolicy:"no-referrer"}}):e("span",[t._v("暂无图片")])]}}])}),e("el-table-column",{attrs:{prop:"base_value",label:"最新图片",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[o.row.base_value?e("el-image",{staticStyle:{width:"100px",height:"80px"},attrs:{src:o.row.base_value,"preview-src-list":[o.row.base_value],fit:"fill",referrerpolicy:"no-referrer"}}):e("span",[t._v("暂无图片")])]}}])}),e("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.editAttribute(o.row)}}},[e("i",{staticClass:"el-icon-edit",attrs:{title:"编辑"}})]),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.configure(o.row)}}},[e("i",{attrs:{title:"AI配置"}},[t._v("AI")])]),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.goPage(o.row)}}},[e("i",{staticClass:"el-icon-tickets",attrs:{title:"记录"}})]),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.getVideo(o.row)}}},[e("i",{staticClass:"el-icon-video-play",attrs:{title:"视频"}})]),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.delAttribute(o.row)}}},[e("i",{staticClass:"el-icon-delete",staticStyle:{color:"red"},attrs:{title:"删除"}})])]}}])})],1),e("el-dialog",{attrs:{title:"分析列表",width:"40%",visible:t.aiValueVisible},on:{"update:visible":function(e){t.aiValueVisible=e}}},[e("el-table",{attrs:{data:t.AiValueList}},[e("el-table-column",{attrs:{label:"报警图片",align:"center",prop:"ai_file"},scopedSlots:t._u([{key:"default",fn:function(o){return[o.row.ai_file?e("el-image",{staticStyle:{width:"100px",height:"100px"},attrs:{src:`${o.row.ai_file}`,"preview-src-list":[`${o.row.ai_file}`],fit:"fill",referrerpolicy:"no-referrer"}}):e("span",[t._v("暂无图片")])]}}])}),e("el-table-column",{attrs:{label:"报警时间",align:"center",prop:"create_time"}}),e("el-table-column",{attrs:{label:"分析内容",align:"center",prop:"analyse_threshold"},scopedSlots:t._u([{key:"default",fn:function(o){return t._l(JSON.parse(o.row.ai_value).ai_class,function(o,i){return e("div",{key:i,staticStyle:{"text-align":"cehter"}},[t._v(" "+t._s(o.name)+":"+t._s(t._f("toFixed")(o.confidence))+" ")])})}}])})],1)],1),e("el-dialog",{attrs:{title:t.attributeVisibleTitle,visible:t.attributeVisible,width:"40%","close-on-click-modal":!1},on:{"update:visible":function(e){t.attributeVisible=e}}},[e("el-form",{ref:"attributeForm",staticStyle:{width:"80%"},attrs:{model:t.attributeForm,rules:t.rules,"label-width":"200px",size:"small"}},[e("el-form-item",{attrs:{label:"通道名称:",prop:"describe"}},[e("el-input",{model:{value:t.attributeForm.describe,callback:function(e){t.$set(t.attributeForm,"describe",e)},expression:"attributeForm.describe"}})],1),e("el-form-item",{attrs:{label:"通道编号:",prop:"channel_id"}},[e("el-input",{model:{value:t.attributeForm.protocol_config.channel_id,callback:function(e){t.$set(t.attributeForm.protocol_config,"channel_id",e)},expression:"attributeForm.protocol_config.channel_id"}})],1),e("el-form-item",{attrs:{label:"视频流地址:",prop:"stream_url"}},[e("el-input",{model:{value:t.attributeForm.protocol_config.stream_url,callback:function(e){t.$set(t.attributeForm.protocol_config,"stream_url",e)},expression:"attributeForm.protocol_config.stream_url"}})],1),e("el-form-item",{attrs:{label:"启用抓拍"}},[e("el-switch",{attrs:{"active-value":1,"inactive-value":2},model:{value:t.attributeForm.protocol_config.is_snap,callback:function(e){t.$set(t.attributeForm.protocol_config,"is_snap",e)},expression:"attributeForm.protocol_config.is_snap"}})],1),e("el-form-item",{attrs:{label:"拍照时间间隔(秒):"}},[e("el-input-number",{attrs:{disabled:2==t.attributeForm.protocol_config.is_snap,min:60},model:{value:t.attributeForm.protocol_config.interval_time,callback:function(e){t.$set(t.attributeForm.protocol_config,"interval_time",e)},expression:"attributeForm.protocol_config.interval_time"}})],1),e("el-form-item",{attrs:{label:"预览视频流分析"}},[e("el-switch",{attrs:{"active-value":1,"inactive-value":2},model:{value:t.attributeForm.protocol_config.is_preview_analysis,callback:function(e){t.$set(t.attributeForm.protocol_config,"is_preview_analysis",e)},expression:"attributeForm.protocol_config.is_preview_analysis"}})],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.attributeVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitAttributeForm("attributeForm")}}},[t._v("确 定")])],1)],1),t.videoVisible?e("el-dialog",{attrs:{title:"视频",width:"60%",visible:t.videoVisible,top:"20px"},on:{"update:visible":function(e){t.videoVisible=e}}},[e("div",{staticStyle:{width:"100%",height:"460px",background:"#000"}},[t.videoVisible?e("videoPlayer",{attrs:{src:t.videoUrl},on:{closeVideo:t.closeVideo}}):t._e()],1)]):t._e()],1)},y=[],I=(o(7644),o(2563),{props:{chooseItem:{type:Object,default:()=>({})},sourceTab:{type:Number}},components:{videoPlayer:r.A},data(){return{loading:!1,attributeList:[],attributeParams:{page:1,size:10},timer:null,attributeTotal:0,aiValueVisible:!1,queryParams:{page:1,size:10},AiList:[],aitotal:0,AiPropertyList:[],AiValueList:[],attributeVisible:!1,attributeForm:{protocol_config:{}},attributeVisibleTitle:"",rules:{},selectedItems:[],videoVisible:!1,videoUrl:""}},watch:{chooseItem:{handler(t){t.source_id&&(this.chooseItemInfo={...t},this.getAttributeList())},deep:!0,immediate:!0}},filters:{toFixed(t){return parseFloat(t).toFixed(2)}},created(){this.chooseItemInfo={...this.chooseItem}},methods:{closeVideo(){this.$api.get("/media/stopPlay",{params:{pro_id:this.aiItem.pro_id}}).then(()=>{this.$message.success("视频流已关闭")})},getUrl(t){const{hostname:e}=window.location,o=t.replace(this.getIPFromURL(t),e);return o},getIPFromURL(t){const e=t.match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)[0];return e},getVideo(t){this.aiItem=t;let e=1==this.aiItem.protocol_config.is_preview_analysis?"/media/playAnalysis":"/media/play";this.$api.get(e,{params:{pro_id:this.aiItem.pro_id}}).then(t=>{t.data.data.play_url?(this.videoUrl=this.getUrl(t.data.data.play_url),this.videoVisible=!0):this.$message.warning("操作成功")})},getDataAiValueList(t){this.AiValueList=t,this.aiValueVisible=!0},addAttribute(){this.attributeVisibleTitle="添加属性",this.attributeForm={source_id:this.chooseItemInfo.source_id,protocol_config:{interval_time:300,is_snap:2}},this.attributeVisible=!0},handleSelectAll(){},handleChange(t){this.selectedItems=t},handleSelect(){},submitAIForm(){this.$api.post("/ai/addDataAiProperty",{pro_id:this.aiItem.pro_id,ai_id:this.selectedItems.map(t=>t.ai_id)}).then(()=>{this.getAttributeList(),this.$message.success("操作成功")})},delAttribute(t){this.$confirm("是否删除该数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$api.post("/collect/delDataProperty",{pro_id:t.pro_id}).then(()=>{this.$message.success("操作成功"),this.getAttributeList()})}).catch(()=>{this.$message({type:"info",message:"已取消删除"})})},goPage(t){this.$router.push({path:"/collection/records",query:{pro_id:t.pro_id,source_id:this.chooseItem.source_id}})},configure(t){this.aiItem=t,this.AiPropertyList=[],this.selectedItems=[],console.log(this.chooseItem),this.$router.push({path:"/collection/AIConfig",query:{pro_id:t.pro_id,sourceTab:this.sourceTab,source_id:this.chooseItem.source_id,page:this.chooseItem.page}})},submitAttributeForm(t){this.$refs[t].validate(t=>{if(!t)return!1;this.attributeForm.pro_id?this.$api.post("/collect/updateDataProperty",this.attributeForm).then(()=>{this.attributeVisible=!1,this.$message.success("操作成功"),this.getAttributeList()}):this.$api.post("/collect/addDataProperty",this.attributeForm).then(()=>{this.attributeVisible=!1,this.$message.success("操作成功"),this.getAttributeList()})})},editAttribute(t){this.attributeVisibleTitle="编辑属性",this.attributeForm={...t},this.attributeForm.protocol_config=this.analyzeProperty(t.protocol_config)?{...t.protocol_config,interval_time:t.protocol_config.interval_time||300}:{},this.attributeVisible=!0},async getDataAiList(){this.$api.get("/ai/getDataAiPropertyList",{params:{pro_id:this.aiItem.pro_id}}).then(t=>{this.AiPropertyList=t.data.data||[],this.$api.get("/ai/getDataAiList",{params:this.queryParams}).then(t=>{t.data.data&&(this.AiList=t.data.data,this.aitotal=t.data.total,this.AiList.forEach(t=>{this.AiPropertyList.some(e=>e.ai_id===t.ai_id)&&this.$refs.table.toggleRowSelection(t,!0)}))})})},getDataValueList(){this.getData(),this.batchGetAnalysisData()},getAttributeList(){this.attributeList=[],this.loading=!0,this.$api.get("/collect/getDataPropertyList",{params:{...this.attributeParams,source_id:this.chooseItemInfo.source_id}}).then(async t=>{t.data.data?(this.attributeList=t.data.data.map(t=>({...t,protocol_config:t.protocol_config?JSON.parse(t.protocol_config):{}})),this.attributeTotal=t.data.total,await this.batchGetAnalysisData(),this.getDataValueList()):this.attributeList=[]}).finally(()=>{this.loading=!1})},async batchGetAnalysisData(){const t=this.attributeList.map(t=>this.$api.get("/ai/getDataAiValueList",{params:{pro_id:t.pro_id}}).then(e=>{e.data.data&&this.$set(t,"analysisData",e.data.data)}));await Promise.all(t)},getData(){this.$api.get("/collect/getDataValueList",{params:{...this.attributeParams,source_id:this.chooseItemInfo.source_id}}).then(t=>{t.data.data&&this.attributeList.forEach((e,o)=>{const i=t.data.data.find(t=>e.pro_id===t.pro_id);i&&this.$set(this.attributeList,o,{...e,base_value:i.value})})})},analyzeProperty(t){return null!==t&&"null"!==t&&""!==t&&void 0!==t&&("object"!==typeof t||null===t||0!==Object.keys(t).length)}}}),w=I,F=(0,u.A)(w,v,y,!1,null,"708dac28",null),k=F.exports,$=function(){var t=this,e=t._self._c;return e("div",[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{size:"mini",data:t.attributeList}},[e("el-table-column",{attrs:{prop:"identifier",label:"标识符",align:"center"}}),e("el-table-column",{attrs:{prop:"describe",label:"描述",align:"center"}}),e("el-table-column",{attrs:{prop:"data_type",label:"数据类型",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t.data_type.get(e.row.protocol_config.data_type))+" ")]}}])}),e("el-table-column",{attrs:{prop:"operation_type",label:"寄存器操作类型",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t.operation_type.get(e.row.protocol_config.operation_type))+" ")]}}])}),e("el-table-column",{attrs:{prop:"protocol_config",label:"寄存器地址",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config.register_address)+" ")]}}])}),e("el-table-column",{attrs:{prop:"protocol_config",label:"是否交换寄存器高低字节",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(1==e.row.protocol_config.swap_high_low?"是":"否")+" ")]}}])}),e("el-table-column",{attrs:{prop:"base_value",label:"基础值",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.base_value)+" ")]}}])}),e("el-table-column",{attrs:{prop:"scale_factor",label:"比例因子",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config.scale_factor)+" ")]}}])}),e("el-table-column",{attrs:{prop:"latest_value",label:"最新值",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.latest_value)+" ")]}}])}),e("el-table-column",{attrs:{prop:"interval_time",label:"上报时间",align:"center",width:"200"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.time)+" ")]}}])}),e("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.write(o.row)}}},[e("i",{staticClass:"icon iconf-write",attrs:{title:"写入"}})]),e("el-button",{attrs:{type:"text",icon:"el-icon-edit"},on:{click:function(e){return t.editAttribute(o.row)}}}),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.delAttribute(o.row)}}},[e("i",{staticClass:"el-icon-delete",staticStyle:{color:"red"},attrs:{title:"删除"}})])]}}])})],1),e("pagination",{directives:[{name:"show",rawName:"v-show",value:t.attributeTotal>0,expression:"attributeTotal > 0"}],staticClass:"float-right mt-10",attrs:{total:t.attributeTotal,page:t.attributeParams.page,limit:t.attributeParams.size,layout:"total, prev, pager, next",small:""},on:{"update:page":function(e){return t.$set(t.attributeParams,"page",e)},"update:limit":function(e){return t.$set(t.attributeParams,"size",e)},pagination:t.getAttributeList}}),e("el-dialog",{attrs:{title:t.attributeVisibleTitle,visible:t.attributeVisible,width:"40%","close-on-click-modal":!1,top:"0"},on:{"update:visible":function(e){t.attributeVisible=e}}},[e("el-form",{ref:"attributeForm",staticStyle:{width:"80%"},attrs:{model:t.attributeForm,rules:t.rules,"label-width":"200px",size:"small"}},[e("el-form-item",{attrs:{label:"标识符:",prop:"identifier"}},[e("el-input",{model:{value:t.attributeForm.identifier,callback:function(e){t.$set(t.attributeForm,"identifier",e)},expression:"attributeForm.identifier"}})],1),e("el-form-item",{attrs:{label:"描述:",prop:"describe"}},[e("el-input",{model:{value:t.attributeForm.describe,callback:function(e){t.$set(t.attributeForm,"describe",e)},expression:"attributeForm.describe"}})],1),e("el-form-item",{attrs:{label:"数据类型:",prop:"protocol_config.data_type"}},[e("el-select",{model:{value:t.attributeForm.protocol_config.data_type,callback:function(e){t.$set(t.attributeForm.protocol_config,"data_type",e)},expression:"attributeForm.protocol_config.data_type"}},t._l(t.data_type.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o,value:t}})}),1)],1),e("el-form-item",{attrs:{label:"寄存器操作类型:",prop:"protocol_config.operation_type"}},[e("el-select",{model:{value:t.attributeForm.protocol_config.operation_type,callback:function(e){t.$set(t.attributeForm.protocol_config,"operation_type",e)},expression:"attributeForm.protocol_config.operation_type"}},t._l(t.operation_type.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o,value:t}})}),1)],1),e("el-form-item",{attrs:{label:"寄存器地址:",prop:"protocol_config.register_address"}},[e("el-input-number",{model:{value:t.attributeForm.protocol_config.register_address,callback:function(e){t.$set(t.attributeForm.protocol_config,"register_address",e)},expression:"attributeForm.protocol_config.register_address"}})],1),e("el-form-item",{attrs:{label:"交换寄存器内高低字节:",prop:"protocol_config.region"}},[e("el-checkbox",{attrs:{"true-label":1,"false-label":2},model:{value:t.attributeForm.protocol_config.swap_high_low,callback:function(e){t.$set(t.attributeForm.protocol_config,"swap_high_low",e)},expression:"attributeForm.protocol_config.swap_high_low"}})],1),e("el-form-item",{attrs:{label:"基值:",prop:"protocol_config.base_value"}},[e("el-input",{model:{value:t.attributeForm.protocol_config.base_value,callback:function(e){t.$set(t.attributeForm.protocol_config,"base_value",e)},expression:"attributeForm.protocol_config.base_value"}})],1),e("el-form-item",{attrs:{label:"缩放因子:",prop:"protocol_config.scale_factor"}},[e("el-input-number",{model:{value:t.attributeForm.protocol_config.scale_factor,callback:function(e){t.$set(t.attributeForm.protocol_config,"scale_factor",e)},expression:"attributeForm.protocol_config.scale_factor"}})],1),e("el-form-item",{attrs:{label:"小数位数:",prop:"protocol_config.decimal_point"}},[e("el-select",{model:{value:t.attributeForm.protocol_config.decimal_point,callback:function(e){t.$set(t.attributeForm.protocol_config,"decimal_point",e)},expression:"attributeForm.protocol_config.decimal_point"}},t._l(t.decimal_point.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o,value:t}})}),1)],1),2==t.attributeForm.protocol_config.decimal_point?e("el-form-item",{attrs:{label:"小数点个数:",prop:"protocol_config.decimal_point_num"}},[e("el-input-number",{model:{value:t.attributeForm.protocol_config.decimal_point_num,callback:function(e){t.$set(t.attributeForm.protocol_config,"decimal_point_num",e)},expression:"attributeForm.protocol_config.decimal_point_num"}})],1):t._e(),e("el-form-item",{attrs:{label:"采集间隔时间(毫秒):",prop:"protocol_config.interval_time"}},[e("el-input-number",{model:{value:t.attributeForm.protocol_config.interval_time,callback:function(e){t.$set(t.attributeForm.protocol_config,"interval_time",e)},expression:"attributeForm.protocol_config.interval_time"}})],1),e("el-form-item",{attrs:{label:"数据上报方式:",prop:"protocol_config.report_method"}},[e("el-select",{model:{value:t.attributeForm.protocol_config.report_method,callback:function(e){t.$set(t.attributeForm.protocol_config,"report_method",e)},expression:"attributeForm.protocol_config.report_method"}},t._l(t.report_method.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o,value:t}})}),1)],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.attributeVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitAttributeForm("attributeForm")}}},[t._v("确 定")])],1)],1),t.writeVisible?e("el-dialog",{attrs:{title:"写入",width:"40%",visible:t.writeVisible,top:"20px","close-on-click-modal":!1},on:{"update:visible":function(e){t.writeVisible=e}}},[e("el-form",{ref:"writeForm",attrs:{model:t.writeForm,rules:t.writeFormRules,"label-width":"0",size:"small"}},[e("el-form-item",{attrs:{label:"",prop:"value"}},[e("div",{staticClass:"d-flex"},[e("el-input",{on:{input:t.handleInput},model:{value:t.writeForm.value,callback:function(e){t.$set(t.writeForm,"value",e)},expression:"writeForm.value"}}),e("el-input",{staticClass:"ml-10",attrs:{placeholder:"请输入内容"},on:{input:t.handleInput16},model:{value:t.writeForm.decimalNumber,callback:function(e){t.$set(t.writeForm,"decimalNumber",e)},expression:"writeForm.decimalNumber"}},[e("template",{slot:"prepend"},[t._v("0x")])],2)],1)])],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.writeVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitWriteForm()}}},[t._v("确 定")])],1)],1):t._e()],1)},x=[],S=(o(2917),{props:{chooseItem:{type:Object,default:()=>({})}},data(){const t=(t,e,o)=>{const i=/^[-+]?\d*\.?\d+$/;/^-?\d*.?\d+$/.test(e)?i.test(e)?o():o(new Error("请输入有效的十进制")):o(new Error("请输入有效的数字（支持小数"))},e=(t,e,o)=>{const i=/^[0-9A-Fa-f]+$/;i.test(e)?o():o(new Error("请输入有效的十六进制"))};return{loading:!1,attributeList:[],attributeParams:{page:1,size:10},timer:null,attributeTotal:0,operation_type:new Map([[1,"读取线圈状态"],[2,"读取离散输入"],[3,"读取保持寄存器"],[4,"读取输入寄存器"],[5,"写单个线圈"],[6,"写多个线圈"],[7,"写单个保持寄存器"],[8,"写多个保持寄存器"]]),data_type:new Map([[1,"int8"],[2,"int16"],[3,"int32"],[4,"float"],[5,"double"],[6,"bool"],[7,"string"],[8,"bits"]]),decimal_point:new Map([[1,"默认个数"],[2,"指定个数"]]),report_method:new Map([[1,"按时上报"],[2,"变更上报"]]),attributeVisible:!1,attributeForm:{protocol_config:{}},attributeVisibleTitle:"",rules:{},writeVisible:!1,writeForm:{},decimalNumber:"",writeFormRules:{value:[{required:!0,message:"请输入",trigger:["change","blur"]},{validator:t,trigger:["change","blur"]}],decimalNumber:[{required:!0,message:"请输入",trigger:["change","blur"]},{validator:e,trigger:["change","blur"]}]}}},created(){this.chooseItemInfo={...this.chooseItem},this.getAttributeList()},methods:{delAttribute(t){this.$confirm("是否删除该数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$api.post("/collect/delDataProperty",{pro_id:t.pro_id}).then(()=>{this.$message.success("操作成功"),this.getAttributeList()})}).catch(()=>{this.$message({type:"info",message:"已取消删除"})})},handleInput16(){if(!this.writeForm.decimalNumber)return void(this.writeForm.value="");let t=this.writeForm.decimalNumber.replace(/[^0-9A-Fa-f.]/g,"");if(t=t.startsWith("0x")?t.substring(2):t,t.includes(".")){const[e,o]=t.split("."),i=parseInt(e||"0",16),a=this.hexFractionToDecimal(o);this.writeForm.value=(i+a).toString()}else{const e=parseInt(t,16)||0;this.writeForm.value=e.toString()}},handleInput(){if(!this.writeForm.value)return void(this.writeForm.decimalNumber="");const t=this.writeForm.value.replace(/[^0-9.]/g,"");if(t.includes(".")){const[e,o]=t.split("."),i=parseInt(e||"0").toString(16).toUpperCase(),a=this.decimalFractionToHex("0."+o);this.writeForm.decimalNumber=`${i}.${a}`}else{const e=parseInt(t)||0;this.writeForm.decimalNumber=e.toString(16).toUpperCase()}},hexFractionToDecimal(t){return t.split("").reduce((t,e,o)=>t+parseInt(e,16)/Math.pow(16,o+1),0)},decimalFractionToHex(t){let e="",o=parseFloat(t);for(let i=0;i<8&&o>0;i++){o*=16;const t=Math.floor(o);e+=t.toString(16).toUpperCase(),o-=t}return e||"0"},submitWriteForm(){this.$api.post("/collect/controlDataProperty",{identifier:this.attributeForm.identifier,pro_id:this.attributeForm.pro_id,value:this.writeForm.value}).then(()=>{this.writeVisible=!1,this.$message.success("操作成功")})},write(t){this.writeVisible=!0,this.attributeForm=t,this.writeForm={}},editAttribute(t){this.attributeVisibleTitle="编辑属性",this.attributeForm=t,this.attributeForm.protocol_config=this.analyzeProperty(t.protocol_config)?{...t.protocol_config,decimal_point:t.protocol_config.decimal_point||1}:{},this.attributeVisible=!0},submitAttributeForm(t){this.$refs[t].validate(t=>{if(!t)return!1;this.attributeForm.pro_id?this.$api.post("/collect/updateDataProperty",this.attributeForm).then(()=>{this.attributeVisible=!1,this.$message.success("操作成功"),this.getAttributeList()}):this.$api.post("/collect/addDataProperty",this.attributeForm).then(()=>{this.attributeVisible=!1,this.$message.success("操作成功"),this.getAttributeList()})})},addAttribute(){this.attributeVisibleTitle="添加属性",this.attributeForm={source_id:this.chooseItemInfo.source_id,protocol_config:{swap_high_low:0,base_value:0,scale_factor:1,interval_time:1e3,report_method:2,decimal_point:1}},this.attributeVisible=!0},getDataValueList(){this.getData()},getAttributeList(){this.attributeList=[],this.loading=!0,this.$api.get("/collect/getDataPropertyList",{params:{...this.attributeParams,source_id:this.chooseItemInfo.source_id}}).then(async t=>{t.data.data?(this.attributeList=t.data.data.map(t=>({...t,protocol_config:t.protocol_config?JSON.parse(t.protocol_config):{}})),this.attributeTotal=t.data.total,this.getDataValueList()):this.attributeList=[]}).finally(()=>{this.loading=!1})},getData(){this.$api.get("/collect/getDataValueList",{params:{...this.attributeParams,source_id:this.chooseItemInfo.source_id}}).then(t=>{t.data.data&&this.attributeList.forEach((e,o)=>{const i=t.data.data.find(t=>e.pro_id===t.pro_id);i&&this.$set(this.attributeList,o,{...e,latest_value:i.value,time:i.time})})})},analyzeProperty(t){return null!==t&&"null"!==t&&""!==t&&void 0!==t&&("object"!==typeof t||null===t||0!==Object.keys(t).length)}}}),L=S,P=(0,u.A)(L,$,x,!1,null,"3685c54b",null),V=P.exports,C=function(){var t=this,e=t._self._c;return e("div",[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:t.tableData,size:"mini"}},[e("el-table-column",{attrs:{prop:"describe",label:"设备名称",align:"center"}}),e("el-table-column",{attrs:{prop:"identifier",label:"设备编号",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-button",{attrs:{type:"text",size:"mini"},on:{click:function(e){return t.getChannel(o.row)}}},[t._v(t._s(o.row.identifier))])]}}])}),e("el-table-column",{attrs:{label:"设备地址",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config.ip)+":"+t._s(e.row.protocol_config.port)+" ")]}}])}),e("el-table-column",{attrs:{prop:"manufacturer",label:"厂家",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config.manufacturer||"--")+" ")]}}])}),e("el-table-column",{attrs:{prop:"status",label:"状态",width:"100",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-tag",{attrs:{size:"mini",type:"ON"==o.row.protocol_config.status?"success":"info"}},[t._v(" "+t._s("ON"==o.row.protocol_config.status?"在线":"离线"))])]}}])}),e("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.getChannel(o.row)}}},[e("i",{staticClass:"el-icon-video-camera",attrs:{title:"通道"}})]),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.handleDel(o.row)}}},[e("i",{staticClass:"el-icon-delete",staticStyle:{color:"red"},attrs:{title:"删除"}})])]}}])})],1),e("el-dialog",{attrs:{title:"通道列表",visible:t.showChannel,width:"65%","close-on-click-modal":!1},on:{"update:visible":function(e){t.showChannel=e}}},[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:t.channelList,size:"mini"}},[e("el-table-column",{attrs:{prop:"describe",label:"名称","show-overflow-tooltip":"",align:"center"}}),e("el-table-column",{attrs:{prop:"identifier",label:"编号",align:"center",width:"240","show-overflow-tooltip":""},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-button",{attrs:{type:"text",size:"mini"}},[t._v(t._s(o.row.identifier))])]}}])}),e("el-table-column",{attrs:{prop:"ip",label:"地址",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[o.row.protocol_config.ip?e("span",[t._v(" "+t._s(o.row.protocol_config.ip)+":"+t._s(o.row.protocol_config.port)+" ")]):e("span",[t._v("--")])]}}])}),e("el-table-column",{attrs:{prop:"manufacturer",label:"厂家",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config.manufacturer||"--")+" ")]}}])}),e("el-table-column",{attrs:{prop:"status",label:"状态",width:"100",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-tag",{attrs:{size:"mini",type:"ON"==o.row.protocol_config.status?"success":"info"}},[t._v(" "+t._s("ON"==o.row.protocol_config.status?"在线":"离线"))])]}}])}),e("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.getVideo(o.row)}}},[e("i",{staticClass:"el-icon-video-play",attrs:{title:"视频"}})]),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.handleDel(o.row)}}},[e("i",{staticClass:"el-icon-delete",staticStyle:{color:"red"},attrs:{title:"删除"}})])]}}])})],1),e("pagination",{directives:[{name:"show",rawName:"v-show",value:t.channelTotal>0,expression:"channelTotal > 0"}],staticClass:"float-right mt-10",attrs:{total:t.channelTotal,page:t.channelParams.page,limit:t.channelParams.size,layout:"total, prev, pager, next",small:""},on:{"update:page":function(e){return t.$set(t.channelParams,"page",e)},"update:limit":function(e){return t.$set(t.channelParams,"size",e)},pagination:t.getChannelList}})],1),e("pagination",{directives:[{name:"show",rawName:"v-show",value:t.attributeTotal>0,expression:"attributeTotal > 0"}],staticClass:"float-right mt-10",attrs:{total:t.attributeTotal,page:t.attributeParams.page,limit:t.attributeParams.size,layout:"total, prev, pager, next",small:""},on:{"update:page":function(e){return t.$set(t.attributeParams,"page",e)},"update:limit":function(e){return t.$set(t.attributeParams,"size",e)},pagination:t.getAttributeList}}),e("el-dialog",{attrs:{title:t.attributeVisibleTitle,visible:t.attributeVisible,width:"40%","close-on-click-modal":!1},on:{"update:visible":function(e){t.attributeVisible=e}}},[e("el-form",{ref:"attributeForm",staticStyle:{width:"80%"},attrs:{model:t.attributeForm,rules:t.rules,"label-width":"200px",size:"small"}},[e("el-form-item",{attrs:{label:"通道名称:",prop:"describe"}},[e("el-input",{model:{value:t.attributeForm.describe,callback:function(e){t.$set(t.attributeForm,"describe",e)},expression:"attributeForm.describe"}})],1),e("el-form-item",{attrs:{label:"通道编号:",prop:"channel_id"}},[e("el-input",{model:{value:t.attributeForm.protocol_config.channel_id,callback:function(e){t.$set(t.attributeForm.protocol_config,"channel_id",e)},expression:"attributeForm.protocol_config.channel_id"}})],1),e("el-form-item",{attrs:{label:"视频流地址:",prop:"stream_url"}},[e("el-input",{model:{value:t.attributeForm.protocol_config.stream_url,callback:function(e){t.$set(t.attributeForm.protocol_config,"stream_url",e)},expression:"attributeForm.protocol_config.stream_url"}})],1),e("el-form-item",{attrs:{label:"是否启用抓拍"}},[e("el-switch",{attrs:{"active-value":1,"inactive-value":2},model:{value:t.attributeForm.protocol_config.is_snap,callback:function(e){t.$set(t.attributeForm.protocol_config,"is_snap",e)},expression:"attributeForm.protocol_config.is_snap"}})],1),e("el-form-item",{attrs:{label:"拍照时间间隔(秒):"}},[e("el-input-number",{attrs:{disabled:2==t.attributeForm.protocol_config.is_snap,min:60},model:{value:t.attributeForm.protocol_config.interval_time,callback:function(e){t.$set(t.attributeForm.protocol_config,"interval_time",e)},expression:"attributeForm.protocol_config.interval_time"}})],1),e("el-form-item",{attrs:{label:"报警时间间隔(秒):"}},[e("el-input-number",{attrs:{min:0},model:{value:t.attributeForm.protocol_config.alarm_interval,callback:function(e){t.$set(t.attributeForm.protocol_config,"alarm_interval",e)},expression:"attributeForm.protocol_config.alarm_interval"}})],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.attributeVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitAttributeForm("attributeForm")}}},[t._v("确 定")])],1)],1),t.videoVisible?e("el-dialog",{attrs:{title:"视频",width:"60%",visible:t.videoVisible,top:"20px"},on:{"update:visible":function(e){t.videoVisible=e}}},[e("div",{staticStyle:{width:"100%",height:"460px",background:"#000"}},[e("videoPlayer",{staticStyle:{height:"100%"},attrs:{src:t.videoUrl},on:{closeVideo:t.closeVideo}})],1)]):t._e()],1)},D=[],T={props:{chooseItem:{type:Object,default:()=>({})}},components:{videoPlayer:r.A},data(){return{tableData:[],chooseItemInfo:{},attributeParams:{page:1,size:10},loading:!1,protocol_config:{},attributeTotal:0,showChannel:!1,attributeForm:{protocol_config:{}},attributeVisibleTitle:"新增",attributeVisible:!1,rules:{},channelList:[],channelTotal:0,channelParams:{page:1,size:10},videoVisible:!1,aiItem:{}}},watch:{chooseItem:{handler(t){t.source_id&&(this.chooseItemInfo={...t},this.getAttributeList())},deep:!0,immediate:!0}},methods:{closeVideo(){this.$api.get("/media/stopPlayGb",{params:{pro_id:this.aiItem.pro_id}}).then(()=>{this.$message.success("视频流已关闭")})},getUrl(t){const{hostname:e}=window.location,o=t.replace(this.getIPFromURL(t),e);return o},getIPFromURL(t){const e=t.match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)[0];return e},getVideo(t){this.aiItem=t,this.$api.get("/media/playGb",{params:{pro_id:this.aiItem.pro_id}}).then(t=>{t.data.data.play_url?(this.videoUrl=this.getUrl(t.data.data.play_url),this.videoVisible=!0):this.$message.warning("操作成功")})},handleDel(t){this.$confirm("是否删除该数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$api.post("/collect/delDataProperty",{pro_id:t.pro_id}).then(()=>{this.$message.success("操作成功"),this.showChannel?this.getChannelList():this.getAttributeList()})}).catch(()=>{this.$message({type:"info",message:"已取消删除"})})},getChannelList(){this.channelList=[],this.loading=!0,this.$api.get("/collect/getDataPropertyList",{params:{...this.channelParams,source_id:this.chooseItemInfo.source_id,parent_id:this.parentId}}).then(async t=>{t.data.data&&(this.channelList=t.data.data.map(t=>({...t,protocol_config:t.protocol_config?JSON.parse(t.protocol_config):{}})),this.channelTotal=t.data.total)}).finally(()=>{this.loading=!1})},getAttributeList(){this.tableData=[],this.loading=!0,this.$api.get("/collect/getDataPropertyList",{params:{...this.attributeParams,source_id:this.chooseItemInfo.source_id,parent_id:0}}).then(async t=>{t.data.data&&(this.tableData=t.data.data.map(t=>({...t,protocol_config:t.protocol_config?JSON.parse(t.protocol_config):{}})),this.attributeTotal=t.data.total)}).finally(()=>{this.loading=!1})},getChannel(t){this.showChannel=!0,this.parentId=t.identifier,this.getChannelList()}}},A=T,z=(0,u.A)(A,C,D,!1,null,"3c24d50b",null),N=z.exports,O=function(){var t=this,e=t._self._c;return e("div",{staticClass:"d-center column m-10"},[e("el-steps",{staticStyle:{width:"50%"},attrs:{active:t.active,"finish-status":"success"}},[e("el-step",{attrs:{title:"配置通道参数"}}),e("el-step",{attrs:{title:"配置协议参数"}})],1),e("el-form",{directives:[{name:"show",rawName:"v-show",value:0==t.active,expression:"active == 0"}],ref:"channelInfo",staticClass:"mt-20",attrs:{model:t.channelInfo,rules:t.rules,"label-width":"140px",size:"small"}},[e("el-form-item",{attrs:{label:"传输协议:",prop:"transfer_mode"}},[e("el-select",{model:{value:t.channelInfo.transfer_mode,callback:function(e){t.$set(t.channelInfo,"transfer_mode",e)},expression:"channelInfo.transfer_mode"}},[e("el-option",{attrs:{label:"UDP",value:1}}),e("el-option",{attrs:{label:"TCP",value:2}})],1)],1),e("el-form-item",{attrs:{label:"本地ID:",prop:"local_id"}},[e("el-input",{model:{value:t.channelInfo.local_id,callback:function(e){t.$set(t.channelInfo,"local_id",e)},expression:"channelInfo.local_id"}})],1),e("el-form-item",{attrs:{label:"本地域:",prop:"local_domain"}},[e("el-input",{model:{value:t.channelInfo.local_domain,callback:function(e){t.$set(t.channelInfo,"local_domain",e)},expression:"channelInfo.local_domain"}})],1),e("el-form-item",{attrs:{label:"本地IP:",prop:"local_ip"}},[e("el-input",{model:{value:t.channelInfo.local_ip,callback:function(e){t.$set(t.channelInfo,"local_ip",e)},expression:"channelInfo.local_ip"}})],1),e("el-form-item",{attrs:{label:"本地端口:",prop:"local_port"}},[e("el-input-number",{model:{value:t.channelInfo.local_port,callback:function(e){t.$set(t.channelInfo,"local_port",e)},expression:"channelInfo.local_port"}})],1),e("el-form-item",{attrs:{label:"本地密码:",prop:"local_pwd"}},[e("el-input",{attrs:{type:"password","show-password":""},model:{value:t.channelInfo.local_pwd,callback:function(e){t.$set(t.channelInfo,"local_pwd",e)},expression:"channelInfo.local_pwd"}})],1),e("el-form-item",{attrs:{label:"本地收流最小端口:",prop:"rtp_min_port"}},[e("el-input-number",{attrs:{min:3e4},model:{value:t.channelInfo.rtp_min_port,callback:function(e){t.$set(t.channelInfo,"rtp_min_port",e)},expression:"channelInfo.rtp_min_port"}})],1),e("el-form-item",{attrs:{label:"本地收流最大端口:",prop:"rtp_max_port"}},[e("el-input-number",{attrs:{min:3e4},model:{value:t.channelInfo.rtp_max_port,callback:function(e){t.$set(t.channelInfo,"rtp_max_port",e)},expression:"channelInfo.rtp_max_port"}})],1),e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitChannel("channelInfo")}}},[t._v("下一步")])],1)],1),1==t.active?e("el-form",{ref:"protocolInfo",staticClass:"mt-20",attrs:{model:t.protocolInfo,rules:t.rules,"label-width":"140px",size:"small"}},[e("el-form-item",{attrs:{label:"上级平台ID:",prop:"parent_id"}},[e("el-input",{model:{value:t.protocolInfo.parent_id,callback:function(e){t.$set(t.protocolInfo,"parent_id",e)},expression:"protocolInfo.parent_id"}})],1),e("el-form-item",{attrs:{label:"上级平台域:",prop:"parent_domain"}},[e("el-input",{model:{value:t.protocolInfo.parent_domain,callback:function(e){t.$set(t.protocolInfo,"parent_domain",e)},expression:"protocolInfo.parent_domain"}})],1),e("el-form-item",{attrs:{label:"上级平台IP:",prop:"parent_ip"}},[e("el-input",{model:{value:t.protocolInfo.parent_ip,callback:function(e){t.$set(t.protocolInfo,"parent_ip",e)},expression:"protocolInfo.parent_ip"}})],1),e("el-form-item",{attrs:{label:"上级平台端口:",prop:"parent_port"}},[e("el-input-number",{model:{value:t.protocolInfo.parent_port,callback:function(e){t.$set(t.protocolInfo,"parent_port",e)},expression:"protocolInfo.parent_port"}})],1),e("el-form-item",{attrs:{label:"上级平台sip密码:",prop:"parent_pwd"}},[e("el-input",{attrs:{type:"password","show-password":""},model:{value:t.protocolInfo.parent_pwd,callback:function(e){t.$set(t.protocolInfo,"parent_pwd",e)},expression:"protocolInfo.parent_pwd"}})],1),e("el-form-item",{attrs:{label:"注册间隔(秒):",prop:"register_interval"}},[e("el-input-number",{model:{value:t.protocolInfo.register_interval,callback:function(e){t.$set(t.protocolInfo,"register_interval",e)},expression:"protocolInfo.register_interval"}})],1),e("el-form-item",{attrs:{label:"心跳间隔(秒):",prop:"keepalive_interval"}},[e("el-input-number",{model:{value:t.protocolInfo.keepalive_interval,callback:function(e){t.$set(t.protocolInfo,"keepalive_interval",e)},expression:"protocolInfo.keepalive_interval"}})],1),e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){t.active=0}}},[t._v("上一步")]),e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitProtocol("protocolInfo")}}},[t._v("提交")])],1)],1):t._e()],1)},q=[],X={props:{protocolForm:{type:Object,default:()=>({})},channelForm:{type:Object,default:()=>({})},source_id:{type:Number}},data(){let t=(t,e,o)=>{const i=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;i.test(e)?o():o(new Error("格式错误 格式:XXX.XXX.XXX.XXX"))},e=(t,e,o)=>{/^[1-9]\d*$/.test(e)&&1<=1*e&&1*e<=65535?o():o(new Error("端口为30000-65535"))};return{channelInfo:{},protocolInfo:{},rules:{source_name:[{required:!0,message:"请输入",trigger:"blur"}],local_ip:[{required:!0,message:"请输入",trigger:"change"},{validator:t,trigger:"change"}],local_port:[{required:!0,message:"请输入",trigger:"change"},{validator:e,trigger:"change"}],parent_ip:[{required:!0,message:"请输入",trigger:"change"},{validator:t,trigger:"change"}],parent_port:[{required:!0,message:"请输入",trigger:"change"},{validator:e,trigger:"change"}],rtp_min_port:[{required:!0,message:"请输入",trigger:"change"},{validator:e,trigger:"change"}],rtp_max_port:[{required:!0,message:"请输入",trigger:"change"},{validator:e,trigger:"change"}],local_pwd:[{required:!0,message:"请输入",trigger:"blur"}]},active:0,deviceList:[]}},created(){this.channelInfo={...this.channelForm,local_port:this.channelForm.local_port||5060,rtp_min_port:this.channelForm.rtp_min_port||3e4,rtp_max_port:this.channelForm.rtp_max_port||30500,transfer_mode:this.channelForm.transfer_mode||1},this.protocolInfo={...this.protocolForm,register_interval:this.protocolForm.register_interval||3600,keepalive_interval:this.protocolForm.keepalive_interval||60,parent_port:this.protocolForm.parent_port||5060}},methods:{submitChannel(t){this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setChannelConfig",{source_id:this.source_id,channel_config:this.channelInfo}).then(()=>{this.active=1})})},submitProtocol(t){this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setProtocolConfig",{source_id:this.source_id,protocol_config:this.protocolInfo}).then(()=>{this.$parent.goBack(),this.$message.success("操作成功")})})}}},j=X,B=(0,u.A)(j,O,q,!1,null,"00461549",null),M=B.exports,U=function(){var t=this,e=t._self._c;return e("div",{staticClass:"d-center column m-10"},[e("el-steps",{staticStyle:{width:"50%"},attrs:{active:t.active,"finish-status":"success"}},[e("el-step",{attrs:{title:"配置通道参数"}}),e("el-step",{attrs:{title:"配置协议参数"}})],1),e("el-form",{directives:[{name:"show",rawName:"v-show",value:0==t.active,expression:"active == 0"}],ref:"channelInfo",staticClass:"mt-20",attrs:{model:t.channelInfo,"label-width":"140px",size:"small"}},[e("el-form-item",{attrs:{label:"接口类型:",prop:"interface_type"}},[e("el-select",{on:{change:t.getInterfaceList},model:{value:t.channelInfo.interface_type,callback:function(e){t.$set(t.channelInfo,"interface_type",e)},expression:"channelInfo.interface_type"}},[e("el-option",{attrs:{label:"串口",value:1}}),e("el-option",{attrs:{label:"GPIO接口",value:2}})],1)],1),e("el-form-item",{attrs:{label:"接口列表:",prop:"interface_name"}},[e("el-select",{model:{value:t.channelInfo.interface_name,callback:function(e){t.$set(t.channelInfo,"interface_name",e)},expression:"channelInfo.interface_name"}},t._l(t.interfaceList,function(t,o){return e("el-option",{key:o,attrs:{label:t,value:t}})}),1)],1),1==t.channelInfo.interface_type?e("el-form-item",{attrs:{label:"波特率:",prop:"baudrate"}},[e("el-select",{model:{value:t.channelInfo.baudrate,callback:function(e){t.$set(t.channelInfo,"baudrate",e)},expression:"channelInfo.baudrate"}},t._l(t.baudrateList,function(t,o){return e("el-option",{key:o,attrs:{label:t,value:t}})}),1)],1):t._e(),e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitChannel("channelInfo")}}},[t._v("下一步")])],1)],1),1==t.active?e("el-form",{ref:"protocolInfo",staticClass:"mt-20",attrs:{model:t.protocolInfo,rules:t.rules,"label-width":"140px",size:"small"}},[e("el-form-item",{attrs:{label:"采集间隔时间(毫秒):",prop:"interval_time"}},[e("el-input-number",{model:{value:t.protocolInfo.interval_time,callback:function(e){t.$set(t.protocolInfo,"interval_time",e)},expression:"protocolInfo.interval_time"}})],1),e("el-form-item",[e("el-button",{attrs:{size:"small"},on:{click:function(e){t.active=0}}},[t._v("上一步")]),e("el-button",{attrs:{size:"small"},on:{click:function(e){return t.submitProtocol("protocolInfo")}}},[t._v("提交")])],1)],1):t._e()],1)},R=[],J={props:{protocolForm:{type:Object,default:()=>({})},channelForm:{type:Object,default:()=>({})},source_id:{type:Number}},data(){return{channelInfo:{},protocolInfo:{},rules:{},active:0,deviceList:[],interfaceList:[],baudrateList:[2400,4800,9600,19200,38400,57600,115200]}},created(){this.channelInfo={...this.channelForm,interface_type:this.channelForm.interface_type||null,interface_name:this.channelForm.interface_name||null,...1==this.channelForm.interface_type&&{baudrate:this.channelInfo.baudrate||9600}},this.protocolInfo={...this.protocolForm,interval_time:this.protocolForm.interval_time||1e3},this.getInterfaceList()},methods:{getInterfaceList(t){t&&(this.channelInfo.interface_name="",this.channelInfo.baudrate=1==t?9600:void 0);let e=2==t?"/collect/getGpioList":"/collect/getSerialPortList";this.$api.get(e).then(t=>{this.interfaceList=t.data.data})},submitChannel(t){this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setChannelConfig",{source_id:this.source_id,channel_config:this.channelInfo}).then(()=>{this.active=1})})},submitProtocol(t){this.$refs[t].validate(t=>{if(!t)return!1;this.$api.post("/collect/setProtocolConfig",{source_id:this.source_id,protocol_config:this.protocolInfo}).then(()=>{this.$parent.goBack(),this.$message.success("操作成功")})})}}},E=J,G=(0,u.A)(E,U,R,!1,null,"e1801a74",null),K=G.exports,W=function(){var t=this,e=t._self._c;return e("div",[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{size:"mini",data:t.attributeList}},[e("el-table-column",{attrs:{prop:"identifier",label:"标识符",align:"center"}}),e("el-table-column",{attrs:{prop:"describe",label:"描述",align:"center"}}),e("el-table-column",{attrs:{prop:"data_type",label:"数据类型",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t.data_type.get(e.row.protocol_config.data_type))+" ")]}}])}),e("el-table-column",{attrs:{prop:"protocol_config",label:"是否交换高低字节",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(1==e.row.protocol_config.swap_high_low?"是":"否")+" ")]}}])}),e("el-table-column",{attrs:{prop:"base_value",label:"最新值",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.base_value)+" ")]}}])}),e("el-table-column",{attrs:{prop:"scale_factor",label:"缩放因子",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.protocol_config.scale_factor)+" ")]}}])}),e("el-table-column",{attrs:{prop:"report_method",label:"上报方式",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t.report_method.get(e.row.protocol_config.report_method))+" ")]}}])}),e("el-table-column",{attrs:{prop:"interval_time",label:"上报时间",align:"center",width:"150"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(e.row.time)+" ")]}}])}),e("el-table-column",{attrs:{label:"操作"},scopedSlots:t._u([{key:"default",fn:function(o){return[e("el-button",{attrs:{type:"text",icon:"el-icon-edit"},on:{click:function(e){return t.editAttribute(o.row)}}}),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.delAttribute(o.row)}}},[e("i",{staticClass:"el-icon-delete",staticStyle:{color:"red"},attrs:{title:"删除"}})])]}}])})],1),e("pagination",{directives:[{name:"show",rawName:"v-show",value:t.attributeTotal>0,expression:"attributeTotal > 0"}],staticClass:"float-right mt-10",attrs:{total:t.attributeTotal,page:t.attributeParams.page,limit:t.attributeParams.size,layout:"total, prev, pager, next",small:""},on:{"update:page":function(e){return t.$set(t.attributeParams,"page",e)},"update:limit":function(e){return t.$set(t.attributeParams,"size",e)},pagination:t.getAttributeList}}),e("el-dialog",{attrs:{title:t.attributeVisibleTitle,visible:t.attributeVisible,width:"40%","close-on-click-modal":!1,top:"5vh"},on:{"update:visible":function(e){t.attributeVisible=e}}},[e("el-form",{ref:"attributeForm",staticStyle:{width:"80%"},attrs:{model:t.attributeForm,rules:t.rules,"label-width":"200px",size:"small"}},[e("el-form-item",{attrs:{label:"标识符:",prop:"identifier"}},[e("el-input",{model:{value:t.attributeForm.identifier,callback:function(e){t.$set(t.attributeForm,"identifier",e)},expression:"attributeForm.identifier"}})],1),e("el-form-item",{attrs:{label:"描述:",prop:"describe"}},[e("el-input",{model:{value:t.attributeForm.describe,callback:function(e){t.$set(t.attributeForm,"describe",e)},expression:"attributeForm.describe"}})],1),e("el-form-item",{attrs:{label:"起始地址:",prop:"protocol_config.start_address"}},[e("el-input-number",{model:{value:t.attributeForm.protocol_config.start_address,callback:function(e){t.$set(t.attributeForm.protocol_config,"start_address",e)},expression:"attributeForm.protocol_config.start_address"}})],1),e("el-form-item",{attrs:{label:"数据类型:",prop:"protocol_config.data_type"}},[e("el-select",{model:{value:t.attributeForm.protocol_config.data_type,callback:function(e){t.$set(t.attributeForm.protocol_config,"data_type",e)},expression:"attributeForm.protocol_config.data_type"}},t._l(t.data_type.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o,value:t}})}),1)],1),e("el-form-item",{attrs:{label:"交换内高低字节:",prop:"protocol_config.region"}},[e("el-checkbox",{attrs:{"true-label":1,"false-label":2},model:{value:t.attributeForm.protocol_config.swap_high_low,callback:function(e){t.$set(t.attributeForm.protocol_config,"swap_high_low",e)},expression:"attributeForm.protocol_config.swap_high_low"}})],1),e("el-form-item",{attrs:{label:"基值:",prop:"protocol_config.base_value"}},[e("el-input",{model:{value:t.attributeForm.protocol_config.base_value,callback:function(e){t.$set(t.attributeForm.protocol_config,"base_value",e)},expression:"attributeForm.protocol_config.base_value"}})],1),e("el-form-item",{attrs:{label:"缩放因子:",prop:"protocol_config.scale_factor"}},[e("el-input-number",{model:{value:t.attributeForm.protocol_config.scale_factor,callback:function(e){t.$set(t.attributeForm.protocol_config,"scale_factor",e)},expression:"attributeForm.protocol_config.scale_factor"}})],1),e("el-form-item",{attrs:{label:"小数位数:",prop:"protocol_config.decimal_point"}},[e("el-select",{model:{value:t.attributeForm.protocol_config.decimal_point,callback:function(e){t.$set(t.attributeForm.protocol_config,"decimal_point",e)},expression:"attributeForm.protocol_config.decimal_point"}},t._l(t.decimal_point.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o,value:t}})}),1)],1),2==t.attributeForm.protocol_config.decimal_point?e("el-form-item",{attrs:{label:"小数点个数:",prop:"protocol_config.decimal_point_num"}},[e("el-input-number",{model:{value:t.attributeForm.protocol_config.decimal_point_num,callback:function(e){t.$set(t.attributeForm.protocol_config,"decimal_point_num",e)},expression:"attributeForm.protocol_config.decimal_point_num"}})],1):t._e(),e("el-form-item",{attrs:{label:"数据上报方式:",prop:"protocol_config.report_method"}},[e("el-select",{model:{value:t.attributeForm.protocol_config.report_method,callback:function(e){t.$set(t.attributeForm.protocol_config,"report_method",e)},expression:"attributeForm.protocol_config.report_method"}},t._l(t.report_method.entries(),function([t,o]){return e("el-option",{key:t,attrs:{label:o,value:t}})}),1)],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.attributeVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitAttributeForm("attributeForm")}}},[t._v("确 定")])],1)],1)],1)},H=[],Q={props:{chooseItem:{type:Object,default:()=>({})}},data(){return{loading:!1,attributeList:[],attributeParams:{page:1,size:10},timer:null,attributeTotal:0,data_type:new Map([[1,"int8"],[2,"int16"],[3,"int32"],[4,"float"],[5,"double"],[6,"bool"],[7,"string"],[8,"bits"]]),decimal_point:new Map([[1,"默认个数"],[2,"指定个数"]]),report_method:new Map([[1,"按时上报"],[2,"变更上报"]]),attributeVisible:!1,attributeForm:{protocol_config:{}},attributeVisibleTitle:"",rules:{}}},created(){this.chooseItemInfo={...this.chooseItem},this.getAttributeList()},methods:{delAttribute(t){this.$confirm("是否删除该数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$api.post("/collect/delDataProperty",{pro_id:t.pro_id}).then(()=>{this.$message.success("操作成功"),this.getAttributeList()})}).catch(()=>{this.$message({type:"info",message:"已取消删除"})})},editAttribute(t){this.attributeVisibleTitle="编辑属性",this.attributeForm=t,this.attributeForm.protocol_config=this.analyzeProperty(t.protocol_config)?{...t.protocol_config,decimal_point:t.protocol_config.decimal_point||1}:{},this.attributeVisible=!0},submitAttributeForm(t){this.$refs[t].validate(t=>{if(!t)return!1;this.attributeForm.pro_id?this.$api.post("/collect/updateDataProperty",this.attributeForm).then(()=>{this.attributeVisible=!1,this.$message.success("操作成功"),this.getAttributeList()}):this.$api.post("/collect/addDataProperty",this.attributeForm).then(()=>{this.attributeVisible=!1,this.$message.success("操作成功"),this.getAttributeList()})})},addAttribute(){this.attributeVisibleTitle="添加属性",this.attributeForm={source_id:this.chooseItemInfo.source_id,protocol_config:{start_address:0,scale_factor:1,decimal_point:1,report_method:2}},this.attributeVisible=!0},getDataValueList(){this.getData()},getAttributeList(){this.attributeList=[],this.loading=!0,this.$api.get("/collect/getDataPropertyList",{params:{...this.attributeParams,source_id:this.chooseItemInfo.source_id}}).then(async t=>{t.data.data?(this.attributeList=t.data.data.map(t=>({...t,protocol_config:t.protocol_config?JSON.parse(t.protocol_config):{}})),this.attributeTotal=t.data.total,this.getDataValueList()):this.attributeList=[]}).finally(()=>{this.loading=!1})},getData(){this.$api.get("/collect/getDataValueList",{params:{...this.attributeParams,source_id:this.chooseItemInfo.source_id}}).then(t=>{t.data.data&&this.attributeList.forEach((e,o)=>{const i=t.data.data.find(t=>e.pro_id===t.pro_id);i&&this.$set(this.attributeList,o,{...e,base_value:i.value,time:i.time})})})},analyzeProperty(t){return null!==t&&"null"!==t&&""!==t&&void 0!==t&&("object"!==typeof t||null===t||0!==Object.keys(t).length)}}},Y=Q,Z=(0,u.A)(Y,W,H,!1,null,"4bc3be92",null),tt=Z.exports,et={components:{videoPlayer:r.A,Onvif:m,Modbus:g,GB28181:M,OnvifList:k,ModbusList:V,GB28181List:N,customize:K,customizeList:tt},data(){return{value1:!1,activeName:"1",tableData:[],dataSourceVisible:!1,ruleForm:{protocol_config:{}},attributeForm:{protocol_config:{interval_time:1,alarm_interval:1}},attributeVisible:!1,showPage:!0,configureDevice:{},dataSourceList:[],dataSource:{page:1,size:4},dataSourceTotal:0,input:"",tagVisible:!1,tagList:[],tagInfo:{},attributeParams:{page:1,size:10},rules:{source_name:[{required:!0,message:"请输入",trigger:"blur"}]},attributeList:[],attributeTotal:0,source_type:new Map([[1,{name:"Modbus",type:"Modbus"}],[2,{name:"Onvif",type:"Onvif"}],[3,{name:"GB28181",type:"GB28181"}],[4,{name:"自定义",type:"customize"}]]),sourceTab:0,timer:null,deviceList:[],chooseItem:{},autoAddVisible:!1,IPloading:!0,aconfigureVisible:!1,AiPropertyList:[],AiList:[],queryParams:{page:1,size:10},aitotal:0,lastSelected:[],selectedItems:[],aiItem:{},loading:!1,aiValueVisible:!1,AiValueList:[],dataSourceVisibleTitle:"添加数据源",attributeVisibleTitle:"添加属性",componentsName:"Onvif",componentsListName:"OnvifList",componentKey:0,protocolForm:{},channelForm:{},componentKeys:0}},created(){console.log(this.sourceTab,"sourceTab")},beforeRouteEnter(t,e,o){o(e=>{e.sourceTab=Number(t.query.sourceTab)||0,e.configureDevice.source_id=t.query.source_id,e.$set(e.dataSource,"page",Number(t.query.page)||1),e.getDataSource("page")})},filters:{toFixed(t){return parseFloat(t).toFixed(2)}},beforeDestroy(){clearInterval(this.timer)},destroyed(){},methods:{getComData(){this.timer=setInterval(()=>{this.$nextTick(()=>{this.$refs.listRef.getDataValueList&&this.$refs.listRef.getDataValueList()})},5e3)},changeSource(t,e){this.timer&&clearInterval(this.timer),this.sourceTab=e,this.chooseItem={...t,page:this.dataSource.page},this.componentsListName=`${this.source_type.get(t.driver_protocol).type}List`,this.componentKey=`${this.componentsListName}_${Date.now()}`,this.getComData()},copyDataSource(t){this.$api.post("/collect/copyDataSource",{source_id:t.source_id,protocol_config:JSON.parse(t.protocol_config)}).then(()=>{this.$message.success("操作成功"),this.getDataSource()})},submitTag(){let t={};this.tagList.forEach(({type:e,value1:o,value2:i})=>{t[o]=2===e?Number(i):i.toString()}),this.$api.post("/collect/setDataTags",{source_id:this.tagInfo.source_id,tags:t}).then(()=>{this.tagVisible=!1,this.$message.success("操作成功"),this.getDataSource()})},delTag(t){this.tagList.splice(t,1)},addTag(){this.tagList.push({type:1})},handleTag(t){if(this.tagInfo=t,this.tagList=[],this.analyzeProperty(t.tags))for(const[e,o]of Object.entries(JSON.parse(t.tags))){const t="number"===typeof o?2:1,i={type:t,value1:e,value2:o.toString()};this.tagList.push(i)}this.tagVisible=!0},delDataSource(t,e){this.$confirm("是否删除该数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$api.post("/collect/delDataSource",{source_id:t.source_id}).then(()=>{this.$message.success("操作成功"),this.dataSource.page>1&&0==e&&this.dataSource.page--,this.getDataSourcePage()})}).catch(()=>{this.$message({type:"info",message:"已取消删除"})})},changeDataStatus(t){const e=5e3,o=Date.now();if(t.lastClickTime=t.lastClickTime||0,!t.lastClickTime)return t.lastClickTime=o,void this.setDataSourceStatus(t);const i=o-t.lastClickTime;if(i<=e)return console.log(`点击间隔不足5秒，剩余时间: ${e-i}ms`),this.$message.warning("您的操作太频繁"),void(t.status=1===t.status?2:1);console.log(`点击间隔超过5秒，当前时间: ${o}`),t.lastClickTime=o,this.setDataSourceStatus(t)},setDataSourceStatus(t){this.$api.post("/collect/setDataSourceStatus",{source_id:t.source_id,status:t.status}).then(()=>{this.$message.success("操作成功")}).catch(()=>{t.status=1===t.status?2:1})},handleClick(){},getDataSourcePage(){this.timer&&clearInterval(this.timer),this.sourceTab=0,this.getDataSource("page")},getDataSource(t){this.dataSourceList=[],this.loading=!0,this.$api.get("/collect/getDataSourceList",{params:this.dataSource}).then(e=>{e.data.data&&(this.dataSourceList=e.data.data.map(t=>({...t,disabled:!1})),this.dataSourceTotal=e.data.total,"page"==t&&(this.chooseItem=this.dataSourceList[this.sourceTab],this.componentsListName=`${this.source_type.get(this.chooseItem.driver_protocol).type}List`,this.componentKey=`${this.componentsListName}_${Date.now()}`,this.getComData()))}).finally(()=>{this.loading=!1})},goBack(){this.showPage=!0,this.getDataSource()},async configureDeviceParameters(t,e){this.timer&&(clearInterval(this.timer),this.timer=null),this.sourceTab=e,this.active=0,this.configureDevice=t,this.changeSource(t,e),this.channelForm=this.analyzeProperty(t.channel_config||null)?JSON.parse(t.channel_config):{},this.protocolForm=this.analyzeProperty(t.protocol_config||null)?JSON.parse(t.protocol_config):{interval:1e3},this.analyzeProperty(t.channel_config||null)?(this.channelForm=JSON.parse(t.channel_config||"{}"),this.protocolForm=JSON.parse(t.protocol_config||"{}"),2==t.driver_protocol&&(this.channelForm.ip=this.extractIPFromONVIF(this.channelForm.address))):(this.channelForm={},this.protocolForm={}),this.showPage=!1,this.componentsName=this.source_type.get(t.driver_protocol).type,this.componentKeys=`${this.componentsName}_${Date.now()}`},extractIPFromONVIF(t){const e=t.match(/\[([a-fA-F0-9:]+)\]/);if(e)return e[1];const o=t.match(/(?:http:\/\/)?(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?/);return o?o[1]:null},addAttribute(){this.$refs.listRef.addAttribute()},editDataSource(t){this.dataSourceVisibleTitle="编辑数据源",this.ruleForm=t,this.dataSourceVisible=!0},submitForm(t){this.$refs[t].validate(t=>{if(!t)return!1;this.ruleForm.source_id?this.$api.post("/collect/updateDataSource",this.ruleForm).then(()=>{this.$message.success("操作成功"),this.dataSourceVisible=!1,this.getDataSource()}):this.$api.post("/collect/addDataSource",this.ruleForm).then(()=>{this.$message.success("操作成功"),this.dataSourceVisible=!1,this.getDataSource()})})},resetForm(t){this.$refs[t].resetFields()},addDataSource(){this.ruleForm={},this.dataSourceVisibleTitle="添加数据源",this.dataSourceVisible=!0},analyzeProperty(t){return null!==t&&"null"!==t&&""!==t&&void 0!==t&&("object"!==typeof t||null===t||0!==Object.keys(t).length)}}},ot=et,it=(0,u.A)(ot,i,a,!1,null,"e3664752",null),at=it.exports}}]);
//# sourceMappingURL=613.9227110f.js.map