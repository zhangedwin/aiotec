"use strict";(self["webpackChunkvideogatewayweb"]=self["webpackChunkvideogatewayweb"]||[]).push([[368],{368:function(a,t,e){e.r(t),e.d(t,{default:function(){return f}});var i=function(){var a=this,t=a._self._c;return t("div",[t("el-page-header",{on:{back:a.goBack}}),t("div",{directives:[{name:"loading",rawName:"v-loading",value:a.loading,expression:"loading"}],staticClass:"d-flex flex-start"},[t("el-button",{staticClass:"el-icon-circle-plus mr-10",attrs:{type:"text"},on:{click:function(t){return a.addTab(a.tabIndex)}}}),a.algorithmList.length>0?t("el-tabs",{staticStyle:{width:"100%"},attrs:{closable:"",size:"small"},on:{"tab-remove":a.removeTab,"tab-click":a.chooseTab},model:{value:a.tabIndex,callback:function(t){a.tabIndex=t},expression:"tabIndex"}},[a._l(a.algorithmList,function(a){return t("el-tab-pane",{key:a.ai_id,attrs:{label:a.ai_name,name:a.name}})}),a.completedDraw?t("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(t){a.completedDraw=!1}}},[a._v("结束绘制")]):t("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(t){a.completedDraw=!0}}},[a._v("绘制区域")]),t("el-button",{attrs:{type:"primary",size:"small",plain:""},on:{click:a.reset}},[a._v("清除全部规则")]),t("div",{staticClass:"mt-10 d-flex",staticStyle:{width:"100%",height:"414px"}},[t("div",{staticStyle:{width:"736px",height:"100%",background:"#000",position:"relative"}},[a.videoVisible?t("videoPlayer",{ref:"videoPlayer",staticStyle:{height:"100%"},attrs:{src:a.videoUrl},on:{"resolution-ready":a.handleResolution,getVideo:a.getVideo,closeVideo:a.closeVideo}}):a._e(),a.canvasVisible?t("DrawPanel",{ref:"canvasVueRef",staticStyle:{height:"100%","z-index":"1",position:"absolute",width:"100%",top:"0"},attrs:{single:"",completedDraw:a.completedDraw,pointArr:a.formData.area,ratio:a.ratio,fullScreen:a.fullScreen},on:{finish:a.handleDrawFinish}}):a._e()],1),t("div",{staticClass:"ml-20"},[t("span",{staticClass:"f-bold fs-16"},[a._v("属性配置")]),t("el-form",{ref:"formData",staticStyle:{width:"80%"},attrs:{model:a.formData,"label-width":"200px",size:"small"}},[t("el-form-item",{attrs:{label:"报警时间间隔(秒):"}},[t("el-input-number",{attrs:{min:0,step:.1},model:{value:a.formData.interval,callback:function(t){a.$set(a.formData,"interval",t)},expression:"formData.interval"}})],1),t("el-form-item",{attrs:{label:"报警阈值:"}},[t("el-input-number",{attrs:{min:.2,step:.1},model:{value:a.formData.threshold,callback:function(t){a.$set(a.formData,"threshold",t)},expression:"formData.threshold"}})],1),t("el-button",{staticStyle:{float:"right"},attrs:{type:"primary"},on:{click:a.saveData}},[a._v("保存")])],1)],1)])],2):t("el-empty",{staticStyle:{width:"100%"},attrs:{description:"暂无内容"}}),t("el-drawer",{attrs:{title:"场景列表",visible:a.sceneVisble,size:"40%"},on:{"update:visible":function(t){a.sceneVisble=t}}},[t("div",{staticClass:"p-20",staticStyle:{position:"relative"}},[t("el-collapse",{attrs:{accordion:""},on:{change:a.handleChange}},a._l(a.sceneList,function(e,i){return t("el-collapse-item",{key:i,attrs:{title:e.scene_name,name:i}},[t("el-checkbox-group",{attrs:{size:"small"},model:{value:a.checkedTabs,callback:function(t){a.checkedTabs=t},expression:"checkedTabs"}},a._l(e.children,function(e){return t("el-checkbox",{key:e.ai_id,attrs:{label:JSON.stringify(e),border:""},on:{change:a.handleCheckedTabs}},[a._v(a._s(e.ai_name))])}),1)],1)}),1)],1),t("div",{staticStyle:{position:"absolute",bottom:"10px",right:"10px"}},[t("el-button",{attrs:{size:"small"},on:{click:function(t){a.sceneVisble=!1}}},[a._v("取 消")])],1)])],1)],1)},s=[],r=(e(5786),e(3239),e(3325),function(){var a=this,t=a._self._c;return t("div",[t("div",{ref:"canvasBox",staticClass:"canvas-box solid"},[t("canvas",{ref:"canvas"}),t("canvas",{ref:"canvasSaveinfo",on:{mousemove:a.handleCanvasSaveMove,mouseup:a.handleCanvasMouseUp,mousedown:a.handleCanvasMouseDown}})])])}),o=[],n=(e(6332),{props:{single:{type:Boolean,required:!0},completedDraw:{type:Boolean,required:!1},pointArr:{type:Array,default:()=>[]},ratio:{type:Number},fullScreen:{type:Boolean,required:!1}},data(){return{canvasForm:{coincidentDistance:10,oIndex:-1,pointArr:[],MovePointArr:[],pointX:"",pointY:"",ctxSave:"",canSave:"",ctx:"",can:"",lineColor:"rgba(64, 158, 255, 1)",open:!0,completedDraw:!1,clickMove:!1,pointColorArr:[]},pointColorArr:JSON.parse(JSON.stringify(this.pointArr))}},watch:{ratio(){this.initCanvas()}},mounted(){this.$nextTick(()=>{this.initCanvas()})},methods:{initCanvas(){this.canvasForm.can=this.$refs.canvas,this.canvasForm.can.width=this.$refs.canvasBox.clientWidth,this.canvasForm.can.height=this.$refs.canvasBox.clientHeight,this.canvasForm.ctx=this.canvasForm.can.getContext("2d"),this.canvasForm.ctx.strokeStyle=this.canvasForm.lineColor,this.canvasForm.ctx.fillStyle="rgba(64, 158, 255,0.1)",this.canvasForm.ctx.lineWidth=4,this.canvasForm.ctx.globalAlpha=.7,this.canvasForm.canSave=this.$refs.canvasSaveinfo,this.canvasForm.canSave.width=this.$refs.canvasBox.clientWidth,this.canvasForm.canSave.height=this.$refs.canvasBox.clientHeight,this.canvasForm.ctxSave=this.canvasForm.canSave.getContext("2d"),this.canvasForm.ctxSave.strokeStyle=this.canvasForm.lineColor,this.canvasForm.ctxSave.fillStyle="rgba(64, 158, 255,0.1)",this.canvasForm.ctxSave.lineWidth=4,this.canvasForm.ctxSave.globalAlpha=.7,this.pointColorArr.map(a=>{a.forEach(a=>{a.x=a.x*this.ratio,a.y=a.y*this.ratio}),a.push(a[0]),a.color="#a0cfff",this.canvasFill(a,a.color)})},canvasText(a,t){this.canvasForm.ctxSave.font="18px Consolas",this.canvasForm.ctxSave.textAlign="center",this.canvasForm.ctxSave.textBaseline="middle",this.canvasForm.ctxSave.fillStyle="red",0==t[0].x?this.canvasForm.ctxSave.fillText(a,t[0].x+100,t[0].y+50):this.canvasForm.ctxSave.fillText(a,t[0].x+10,t[0].y+10),this.canvasForm.ctxSave.arc(t[0].x,t[0].y,3,0,2*Math.PI)},canvasFill(a,t){if(this.canvasForm.ctxSave.clearRect(0,0,this.canvasForm.ctxSave.width,this.canvasForm.ctxSave.height),this.canvasForm.ctxSave.beginPath(),a.length>1){this.canvasForm.ctxSave.moveTo(a[0].x,a[0].y);for(let t=1;t<a.length;t++)this.canvasForm.ctxSave.lineTo(a[t].x,a[t].y);this.canvasForm.ctxSave.fillStyle=`${t}B3`,this.canvasForm.ctxSave.fill(),this.canvasForm.ctxSave.lineTo(a[0].x,a[0].y),this.canvasForm.ctxSave.stroke()}},handleCanvasMouseUp(){this.canvasForm.clickMove&&(this.canvasForm.clickMove=!1,this.canvasForm.pointArr=this.canvasForm.MovePointArr)},handleCanvasMouseDown(a){if(this.completedDraw&&(a.offsetX||a.layerX)){let t,e;this.canvasForm.pointX=void 0==a.offsetX?a.layerX:a.offsetX,this.canvasForm.pointY=void 0==a.offsetY?a.layerY:a.offsetY,this.canvasForm.oIndex>0&&this.canvasForm.pointArr.length>0?(t=this.canvasForm.pointArr[0].x,e=this.canvasForm.pointArr[0].y,this.makearc(this.canvasForm.ctx,t,e,this.GetRandomNum(2,2),0,180,"rgba(102,168,255,1)"),this.canvasForm.pointArr.push({x:t,y:e}),this.canvasSave(this.canvasForm.pointArr),this.saveCanvas()):(t=this.canvasForm.pointX,e=this.canvasForm.pointY,this.makearc(this.canvasForm.ctx,t,e,this.GetRandomNum(2,2),0,180,"rgba(102,168,255,1)"),this.canvasForm.pointArr.push({x:t,y:e}),this.canvasSave(this.canvasForm.pointArr))}},handleCanvasSaveMove(a){if(this.completedDraw&&(a.offsetX||a.layerX)){let t,e;if(this.canvasForm.pointX=void 0==a.offsetX?a.layerX:a.offsetX,this.canvasForm.pointY=void 0==a.offsetY?a.layerY:a.offsetY,this.canvasForm.ctx.clearRect(0,0,this.canvasForm.can.width,this.canvasForm.can.height),this.makearc(this.canvasForm.ctx,this.canvasForm.pointX,this.canvasForm.pointY,this.GetRandomNum(4,4),0,180,"rgba(102,168,255,1)"),this.canvasForm.pointArr.length>0){if(this.canvasForm.pointX>this.canvasForm.pointArr[0].x-15&&this.canvasForm.pointX<this.canvasForm.pointArr[0].x+15&&this.canvasForm.pointY>this.canvasForm.pointArr[0].y-15&&this.canvasForm.pointY<this.canvasForm.pointArr[0].y+15?this.canvasForm.pointArr.length>1&&(t=this.canvasForm.pointArr[0].x,e=this.canvasForm.pointArr[0].y,this.canvasForm.ctx.clearRect(0,0,this.canvasForm.can.width,this.canvasForm.can.height),this.makearc(this.canvasForm.ctx,t,e,this.GetRandomNum(4,4),0,180,"rgba(102,168,255,1)"),this.canvasForm.oIndex=1):(t=this.canvasForm.pointX,e=this.canvasForm.pointY,this.canvasForm.oIndex=-1),this.canvasForm.ctx.beginPath(),this.canvasForm.ctx.moveTo(this.canvasForm.pointArr[0].x,this.canvasForm.pointArr[0].y),this.canvasForm.pointArr.length>1)for(let a=1;a<this.canvasForm.pointArr.length;a++)this.canvasForm.ctx.lineTo(this.canvasForm.pointArr[a].x,this.canvasForm.pointArr[a].y);this.canvasForm.ctx.lineTo(t,e),this.canvasForm.ctx.fillStyle="rgba(161,195,255,1)",this.canvasForm.ctx.fill(),this.canvasForm.ctx.stroke()}}},canvasSave(a){if(this.canvasForm.ctxSave.clearRect(0,0,this.canvasForm.ctxSave.width,this.canvasForm.ctxSave.height),this.canvasForm.ctxSave.beginPath(),a.length>1){this.canvasForm.ctxSave.moveTo(a[0].x,a[0].y);for(let t=1;t<a.length;t++)this.canvasForm.ctxSave.lineTo(a[t].x,a[t].y),this.canvasForm.ctxSave.fillStyle="rgba(161,195,255,0.2)",this.canvasForm.ctxSave.stroke();this.canvasForm.ctxSave.closePath()}if(a.length>1){let{0:t,[a.length-1]:e}=a;t.x==e.x&&e.y==e.y&&console.log("结束绘制")}},saveCanvas(){this.canvasForm.pointArr.length<=3?this.revoke():(this.canvasForm.ctx.clearRect(0,0,this.canvasForm.can.width,this.canvasForm.can.height),this.canvasForm.ctxSave.closePath(),this.canvasForm.ctxSave.fill(),this.canvasForm.ctxSave.stroke(),this.$emit("finish",this.canvasForm.pointArr.slice(1)),this.canvasForm.pointArr=[])},GetRandomNum(a,t){let e=t-a,i=Math.random();return a+Math.round(i*e)},makearc(a,t,e,i,s,r,o){a.clearRect(0,0,199,202),a.beginPath(),a.fillStyle=o,a.arc(t,e,i,s,r),a.fill()},reset(){this.canvasForm.ctx.clearRect(0,0,this.canvasForm.can.width,this.canvasForm.can.height),this.canvasForm.ctxSave.clearRect(0,0,this.canvasForm.canSave.width,this.canvasForm.canSave.height),this.canvasForm.pointArr=[],this.canvasForm.completedDraw=!1,this.canvasForm.open=!1},revoke(){this.canvasForm.open&&this.single&&this.reset(),this.canvasForm.ctx.clearRect(0,0,this.canvasForm.can.width,this.canvasForm.can.height),this.canvasForm.ctxSave.clearRect(0,0,this.canvasForm.canSave.width,this.canvasForm.canSave.height),this.canvasForm.pointArr.pop(),this.canvasForm.pointArr.map(a=>{let t={layerX:a.x,layerY:a.y};this.handleCanvasSaveMove(t)})}}}),c=n,h=e(6790),l=(0,h.A)(c,r,o,!1,null,"500a5bac",null),v=l.exports,m=e(2985),d={components:{DrawPanel:v,videoPlayer:m.A},data(){return{tabIndex:"0",algorithmList:[],formData:{area:[],threshold:.5,interval:60},videoUrl:"",canvasVisible:!1,sceneVisble:!1,sceneList:[],activeNames:0,checkAll:!1,checkedTabs:[],isIndeterminate:!0,ratio:1,completedDraw:!1,pointArr:[],fullScreen:!1,pro_id:"",loading:!1,videoVisible:!1,videLoad:!1}},created(){this.getSceneList(),this.formData.pro_id=Number(this.$route.query.pro_id),this.getDataAiPropertyList()},beforeRouteLeave(a,t,e){if("collectionConfiguration"==a.name){const{source_id:t,sourceTab:e,page:i}=this.$route.query;a.query.source_id=t,a.query.sourceTab=e,a.query.page=i}e()},mounted(){},methods:{closeVideo(){this.$api.get("/media/stopPlay",{params:{pro_id:this.formData.pro_id}})},goBack(){this.$router.back()},handleResolution(a){this.ratio=a.boxWdith/a.videoWidth,this.videLoad=!0,this.canvasVisible=!0},getVideo(){this.$api.get("/media/play",{params:{pro_id:this.formData.pro_id}}).then(a=>{a.data.data.play_url?(this.videoUrl=this.getUrl(a.data.data.play_url),this.videoVisible=!0):this.$message.warning("操作成功")})},getUrl(a){const{hostname:t}=window.location,e=a.replace(this.getIPFromURL(a),t);return e},getIPFromURL(a){const t=a.match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)[0];return t},chooseTab(){this.completedDraw=!1,this.getDataAiPropertyList()},saveData(){this.formData.ai_id=this.algorithmList[this.tabIndex].ai_id,this.formData.ai_pro_id=this.algorithmList[this.tabIndex].ai_pro_id,this.formData.area=JSON.stringify(this.formData.area),this.$api.post("/ai/updateDataAiProperty",this.formData).then(()=>{this.getDataAiPropertyList(),this.$message.success("操作成功")})},async getDataAiPropertyList(){this.loading=!0,this.canvasVisible=!1,this.checkedTabs=[],this.$api.get("/ai/getDataAiPropertyList",{params:{pro_id:this.formData.pro_id}}).then(a=>{if(a.data.data){this.algorithmList=a.data.data.map((a,t)=>({...a,name:t.toString()}))||[],this.checkedTabs=a.data.data.map(a=>{let t={ai_id:a.ai_id,ai_name:a.ai_name};return JSON.stringify(t)});let t=this.algorithmList[this.tabIndex];this.formData={...t,area:t.area?JSON.parse(t.area):[],threshold:t.threshold||.5,interval:t.interval||60},this.videoUrl?this.canvasVisible=this.videLoad:this.getVideo()}else this.algorithmList=[]}).finally(()=>{this.loading=!1})},reset(){this.$refs.canvasVueRef.reset(),this.formData.area=[]},handleDrawFinish(a){let t=a.map(a=>({x:a.x/this.ratio,y:a.y/this.ratio}));this.formData.area.push(t)},getSceneList(){this.$api.get("/ai/getDataSceneList").then(a=>{this.sceneList=a.data.data})},async handleChange(a){if(""!==a){let t=await this.$api.get("/ai/getDataAiSceneList",{params:{scene_id:this.sceneList[a].scene_id}});if(t.data.data){let e=t.data.data.map(a=>({ai_id:a.ai_id,ai_name:a.ai_name}));this.$set(this.sceneList[a],"children",e)}}},handleCheckedTabs(a,t){let e=JSON.parse(t.target.value);a&&this.$api.post("/ai/addDataAiProperty",{pro_id:this.formData.pro_id,ai_id:[e.ai_id]}).then(()=>{this.getDataAiPropertyList(),this.$message.success("操作成功")})},addTab(){this.sceneVisble=!0},removeTab(a){this.$api.post("/ai/delDataAiProperty",{pro_id:this.formData.pro_id,ai_id:[this.algorithmList[a].ai_id]}).then(()=>{this.getDataAiPropertyList(),this.$message.success("操作成功")})}},beforeDestroy(){this.videoVisible=!1}},p=d,F=(0,h.A)(p,i,s,!1,null,"35583718",null),f=F.exports}}]);
//# sourceMappingURL=368.0f63854b.js.map